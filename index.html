<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>PredictShot — Web 400x400 (Menu + Rankings)</title>
  <style>
    :root{
      --hud-gap: 10px;
      --pad-size: clamp(120px, 28vw, 180px);
      --safe-bot: env(safe-area-inset-bottom, 8px);
      --card-bg: #0f141b;
      --card-bd: #1f2a37;
    }
    html,body{margin:0;height:100%;background:#0b0f14;color:#e6e6e6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    #app{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto;}
    /* Game area */
    #gameWrap{position:relative;display:grid;place-items:center;padding:6px 6px calc(var(--safe-bot) + 6px);}
    canvas#gameCanvas{
      width:min(100vw,100vh);height:min(100vw,100vh);max-width:100vmin;max-height:100vmin;
      background:#000;border-radius:8px;border:2px solid #60a5fa;box-shadow:0 6px 20px rgba(0,0,0,.6);
      image-rendering:pixelated;
    }
    /* Bottom HUD (joystick only) */
    #hudBar{
      position:sticky;bottom:0;display:flex;align-items:center;justify-content:flex-start;
      gap:var(--hud-gap);padding:8px 10px calc(var(--safe-bot) + 8px);
      background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(10,14,18,.65) 25%, rgba(10,14,18,.85) 100%);
      backdrop-filter:blur(6px);
    }
    .pad{position:relative;width:var(--pad-size);height:var(--pad-size);border-radius:50%;
      background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);touch-action:none;user-select:none;}
    .stick{position:absolute;left:50%;top:50%;width:40%;height:40%;transform:translate(-50%,-50%);border-radius:50%;
      background:rgba(255,255,255,.25);border:2px solid rgba(255,255,255,.35);box-shadow:0 4px 12px rgba(0,0,0,.45);}    

    /* Overlays (menu / gameover / rankings) */
    .overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:20;}
    .overlay.show{display:grid;}
    .card{width:min(92vw,480px);background:var(--card-bg);border:1px solid var(--card-bd);border-radius:12px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.5)}
    .row{display:grid;gap:10px}
    .row2{display:flex;gap:10px;align-items:center}
    input[type=text], select{width:100%;padding:10px 12px;background:#0b1118;color:#e6e6e6;border:1px solid #223047;border-radius:8px;outline:none;font-size:15px}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    button{border:1px solid #244566;background:#133552;color:#e6f4ff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    button.secondary{background:#1a2332;border-color:#2c3c57;color:#cbd5e1}
    .list{max-height:60vh;overflow:auto;border:1px solid #1f2a37;border-radius:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2a37;font-size:14px;text-align:left}
    th{background:#0c1219;position:sticky;top:0}
    .muted{color:#94a3b8;font-size:13px}
  </style>
</head>
<body>
  <div id="app">
    <div id="gameWrap">
      <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>
    <div id="hudBar">
      <div id="pad" class="pad"><div id="stick" class="stick"></div></div>
    </div>
  </div>

  <!-- Main Menu -->
  <div id="menu" class="overlay show">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">PredictShot</h2>
        <div class="row2">
          <div style="flex:1">
            <label class="muted">Nickname (매판 입력)</label>
            <input id="nickname" type="text" maxlength="16" placeholder="Nickname" />
          </div>
          <div style="width:140px">
            <label class="muted">Mode</label>
            <select id="mode">
              <option value="easy">easy</option>
              <option value="normal" selected>normal</option>
              <option value="hard">hard</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button id="btnRank" class="secondary">Rankings</button>
          <button id="btnStart">Start</button>
        </div>
        <div class="muted">조이스틱: 화면 아래 ⟶ 이동 | 스킬 없음 | 400×400</div>
      </div>
    </div>
  </div>

  <!-- Game Over -->
  <div id="over" class="overlay">
    <div class="card">
      <div class="row">
        <h3 style="margin:0">Game Over</h3>
        <div id="overInfo" class="muted">Score: 0</div>
        <div class="actions">
          <button id="btnMenu" class="secondary">Menu</button>
          <button id="btnRestart">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rankings -->
  <div id="ranks" class="overlay">
    <div class="card">
      <div class="row">
        <h3 style="margin:0">Rankings</h3>
        <div class="row2">
          <div style="width:140px">
            <label class="muted">Mode</label>
            <select id="rkMode">
              <option value="easy">easy</option>
              <option value="normal" selected>normal</option>
              <option value="hard">hard</option>
            </select>
          </div>
          <div style="width:200px">
            <label class="muted">Platform</label>
            <select id="rkPlatform">
              <option value="web-portrait-400">web-portrait-400</option>
              <option value="mobile-portrait">mobile-portrait</option>
            </select>
          </div>
          <div style="flex:1"></div>
          <button id="btnCloseRanks" class="secondary">Close</button>
        </div>
        <div class="list">
          <table>
            <thead><tr><th>#</th><th>Name</th><th>Score</th><th>When</th></tr></thead>
            <tbody id="rkBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase SDK (fill URL/KEY in game.js) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Platform tag for leaderboard split
    window.PLATFORM = 'web-portrait-400';

    // Fit square canvas
    (function(){
      const canvas = document.getElementById('gameCanvas');
      const fit = ()=>{
        const size = Math.min(window.innerWidth, window.innerHeight * 0.74);
        canvas.style.width = size+'px';
        canvas.style.height = size+'px';
      };
      window.addEventListener('resize', fit, {passive:true});
      window.addEventListener('orientationchange', ()=>setTimeout(fit,200));
      fit();
    })();

    // Virtual joystick -> Arrow/WASD + analog axes
    const MobileInput = (()=>{
      const pad = document.getElementById('pad');
      const stick = document.getElementById('stick');
      const state = {ax:0, ay:0, active:false};
      const dead = 0.12, th = 0.2;
      const center = ()=>{const r = pad.getBoundingClientRect(); return {x:r.left+r.width/2,y:r.top+r.height/2,rad:r.width/2}};
      function setAxis(nx,ny){
        const len = Math.hypot(nx,ny)||0, k = len>1?1/len:1; const ax=nx*k, ay=ny*k;
        state.ax = Math.abs(ax)<dead?0:ax; state.ay = Math.abs(ay)<dead?0:ay;
        stick.style.transform = `translate(calc(-50% + ${state.ax*40}%), calc(-50% + ${state.ay*40}%))`;
        emitKeysFromAxes(state.ax, state.ay);
      }
      function onPointer(e){ const c=center(); const p=(e.touches?e.touches[0]:e); setAxis((p.clientX-c.x)/c.rad,(p.clientY-c.y)/c.rad); }
      function start(e){ state.active=true; onPointer(e); }
      function move(e){ if(state.active) onPointer(e); }
      function end(){ state.active=false; setAxis(0,0); }
      pad.addEventListener('touchstart',start,{passive:false});
      pad.addEventListener('touchmove', move,{passive:false});
      pad.addEventListener('touchend',  end,{passive:false});
      pad.addEventListener('touchcancel',end,{passive:false});
      pad.addEventListener('pointerdown',start); pad.addEventListener('pointermove',move); pad.addEventListener('pointerup',end); pad.addEventListener('pointerleave',end);

      let held={};
      function fire(code,type){ window.dispatchEvent(new KeyboardEvent(type,{key:code,code,bubbles:true})); }
      function setHeld(k,v,key){ if(held[k]!==v){ held[k]=v; fire(key, v?'keydown':'keyup'); } }
      function emitKeysFromAxes(x,y){
        setHeld('L', x<-th, 'ArrowLeft'); setHeld('R', x>th, 'ArrowRight'); setHeld('U', y<-th, 'ArrowUp'); setHeld('D', y>th, 'ArrowDown');
        setHeld('LA',x<-th,'KeyA'); setHeld('RD',x>th,'KeyD'); setHeld('UW',y<-th,'KeyW'); setHeld('DS',y>th,'KeyS');
      }
      return { getAxis:()=>({x:state.ax,y:state.ay}) };
    })();
    window.MobileInput = MobileInput;

    // Menu wiring
    (function(){
      const $ = (s)=>document.querySelector(s);
      $('#btnStart').onclick = ()=>{
        const name = ($('#nickname').value||'').trim();
        const mode = $('#mode').value;
        window.startGameFromMenu(name, mode);
      };
      $('#btnRank').onclick = ()=>{
        document.getElementById('ranks').classList.add('show');
        window.refreshRanks();
      };
      $('#btnCloseRanks').onclick = ()=>{
        document.getElementById('ranks').classList.remove('show');
      };
      $('#rkMode').onchange = window.refreshRanks;
      $('#rkPlatform').onchange = window.refreshRanks;
      $('#btnMenu').onclick = ()=>{
        document.getElementById('over').classList.remove('show');
        document.getElementById('menu').classList.add('show');
      };
      $('#btnRestart').onclick = ()=>{
        document.getElementById('over').classList.remove('show');
        window.restartSameSettings();
      };
    })();
  </script>

  <script src="./game.js"></script>
</body>
</html>
