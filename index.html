<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>PredictShot — Mobile Portrait</title>
  <style>
    :root{
      --hud-gap: 14px;
      --pad-size: clamp(180px, 36vw, 260px);
      --btn-size: clamp(70px, 16vw, 120px);
      --safe-bot: env(safe-area-inset-bottom, 12px);
    }
    html,body{margin:0;height:100%;background:#0b0f14;color:#e6e6e6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    #app{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto;}
    /* ===== Game area (keeps 1:1 while fitting width) ===== */
    #gameWrap{position:relative;display:grid;place-items:center;padding:8px 8px calc(var(--safe-bot) + 8px);}
    canvas#gameCanvas{width:min(100vw,100vh);height:min(100vw,100vh);max-width:100vmin;max-height:100vmin;background:#000;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.6);image-rendering:pixelated;}
    /* ===== HUD bottom bar ===== */
    #hudBar{position:sticky;bottom:0;display:flex;align-items:center;justify-content:space-between;gap:var(--hud-gap);padding:10px 14px calc(var(--safe-bot) + 10px);background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(10,14,18,.65) 25%, rgba(10,14,18,.85) 100%);backdrop-filter:blur(6px);}
    .pad{position:relative;width:var(--pad-size);height:var(--pad-size);border-radius:50%;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);touch-action:none;user-select:none;}
    .stick{position:absolute;left:50%;top:50%;width:40%;height:40%;transform:translate(-50%,-50%);border-radius:50%;background:rgba(255,255,255,.25);border:2px solid rgba(255,255,255,.35);box-shadow:0 4px 12px rgba(0,0,0,.45);}    
    .btn-skill{width:var(--btn-size);height:var(--btn-size);border-radius:50%;display:grid;place-items:center;font-weight:800;letter-spacing:.4px;background:rgba(82,196,255,.18);border:2px solid rgba(82,196,255,.45);user-select:none;}
    .btn-skill:active{transform:scale(.98)}
    /* Name modal */
    .modal{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);}
    .card{width:min(92vw,460px);background:#0f141b;border:1px solid #1f2a37;border-radius:14px;padding:20px;box-shadow:0 12px 30px rgba(0,0,0,.5)}
    .row{display:grid;gap:12px}
    input[type=text]{width:100%;padding:12px 14px;background:#0b1118;color:#e6e6e6;border:1px solid #223047;border-radius:10px;outline:none;font-size:16px}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
    button{border:1px solid #244566;background:#133552;color:#e6f4ff;padding:10px 14px;border-radius:10px;font-weight:700}
    button.secondary{background:#1a2332;border-color:#2c3c57;color:#cbd5e1}
    /* Landscape hint (we prefer portrait) */
    @media (orientation:landscape){ #landHint{display:grid} }
    #landHint{position:fixed;inset:0;display:none;place-items:center;background:#0b0f14;color:#cbd5e1;z-index:9999;text-align:center;padding:24px}
  </style>
</head>
<body>
  <div id="landHint"><div>
    <h2>세로 모드로 플레이해</h2>
    <p>조이스틱은 아래. 위는 정사각형 게임 화면.</p>
  </div></div>

  <div id="app">
    <!-- Game square on top -->
    <div id="gameWrap">
      <canvas id="gameCanvas" width="900" height="900"></canvas>
    </div>
    <!-- Bottom HUD: joystick left, skill right -->
    <div id="hudBar">
      <div id="pad" class="pad"><div id="stick" class="stick"></div></div>
      <div style="flex:1"></div>
      <div id="skill" class="btn-skill">SKILL</div>
    </div>
  </div>

  <!-- Name modal: always ask per run -->
  <div id="nameModal" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <div class="row">
        <h3 style="margin:0">Enter your nickname</h3>
        <p style="margin:0;color:#9fb3c8">매번 묻는다. 한 폰으로 여러 명 가능.</p>
        <input id="playerNameInput" type="text" maxlength="16" placeholder="Nickname" />
        <div class="actions">
          <button id="randomBtn" class="secondary">Random</button>
          <button id="startBtn">Start</button>
        </div>
      </div>
    </div>
  </div>

  <!-- OPTIONAL: Supabase SDK (uncomment when deploying) -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> -->

  <script>
    // Platform tag for leaderboard separation
    window.PLATFORM = 'mobile-portrait';

    // Fit square canvas to viewport (reserve ~26% height for HUD)
    (function(){
      const canvas = document.getElementById('gameCanvas');
      const fit = ()=>{
        const size = Math.min(window.innerWidth, window.innerHeight * 0.74);
        canvas.style.width = size+'px';
        canvas.style.height = size+'px';
      };
      window.addEventListener('resize', fit, {passive:true});
      window.addEventListener('orientationchange', ()=>setTimeout(fit,200));
      fit();
    })();

    // Virtual joystick => Arrow/WASD + analog axes
    const MobileInput = (()=>{
      const pad = document.getElementById('pad');
      const stick = document.getElementById('stick');
      const state = {ax:0, ay:0, active:false};
      const dead = 0.12, th = 0.2;
      const center = ()=>{const r = pad.getBoundingClientRect(); return {x:r.left+r.width/2,y:r.top+r.height/2,rad:r.width/2}};
      function setAxis(nx,ny){
        const len = Math.hypot(nx,ny)||0, k = len>1?1/len:1; const ax=nx*k, ay=ny*k;
        state.ax = Math.abs(ax)<dead?0:ax; state.ay = Math.abs(ay)<dead?0:ay;
        stick.style.transform = `translate(calc(-50% + ${state.ax*40}%), calc(-50% + ${state.ay*40}%))`;
        emitKeysFromAxes(state.ax, state.ay);
      }
      function onPointer(e){ const c=center(); const p=(e.touches?e.touches[0]:e); setAxis((p.clientX-c.x)/c.rad,(p.clientY-c.y)/c.rad); }
      function start(e){ state.active=true; onPointer(e); }
      function move(e){ if(state.active) onPointer(e); }
      function end(){ state.active=false; setAxis(0,0); }
      pad.addEventListener('touchstart',start,{passive:false});
      pad.addEventListener('touchmove', move,{passive:false});
      pad.addEventListener('touchend',  end,{passive:false});
      pad.addEventListener('touchcancel',end,{passive:false});
      pad.addEventListener('pointerdown',start); pad.addEventListener('pointermove',move); pad.addEventListener('pointerup',end); pad.addEventListener('pointerleave',end);

      let held={L:false,R:false,U:false,D:false};
      function fire(code,type){ window.dispatchEvent(new KeyboardEvent(type,{key:code,code,bubbles:true})); }
      function setHeld(k,v,key){ if(held[k]!==v){ held[k]=v; fire(key, v?'keydown':'keyup'); } }
      function emitKeysFromAxes(x,y){
        setHeld('L', x<-th, 'ArrowLeft'); setHeld('R', x>th, 'ArrowRight'); setHeld('U', y<-th, 'ArrowUp'); setHeld('D', y>th, 'ArrowDown');
        setHeld('LA',x<-th,'KeyA'); setHeld('RD',x>th,'KeyD'); setHeld('UW',y<-th,'KeyW'); setHeld('DS',y>th,'KeyS');
      }
      return { getAxis:()=>({x:state.ax,y:state.ay}) };
    })();
    window.MobileInput = MobileInput;

    // Skill button => Space
    (function(){
      const btn=document.getElementById('skill');
      const press=()=>window.dispatchEvent(new KeyboardEvent('keydown',{key:' ',code:'Space',bubbles:true}));
      const release=()=>window.dispatchEvent(new KeyboardEvent('keyup',{key:' ',code:'Space',bubbles:true}));
      btn.addEventListener('touchstart',e=>{e.preventDefault();press();});
      btn.addEventListener('touchend',e=>{e.preventDefault();release();});
      btn.addEventListener('pointerdown',press); btn.addEventListener('pointerup',release);
    })();

    // Nickname modal each run
    let PLAYER_NAME=null;
    function randomName(){const animals=['Raven','Falcon','Tiger','Eagle','Wolf','Viper','Drake','Shark','Panda','Lynx'];const n=Math.floor(Math.random()*900)+100;return animals[Math.floor(Math.random()*animals.length)]+'-'+n;}
    function openNameModal(){
      const modal=document.getElementById('nameModal');
      const input=document.getElementById('playerNameInput');
      const startBtn=document.getElementById('startBtn');
      const randomBtn=document.getElementById('randomBtn');
      modal.style.display='grid'; input.value=''; input.focus();
      randomBtn.onclick=()=>{input.value=randomName();input.focus();};
      startBtn.onclick=()=>{ const v=(input.value||'').trim(); PLAYER_NAME=v.length?v:randomName(); modal.style.display='none'; window.dispatchEvent(new CustomEvent('player-name-set',{detail:{name:PLAYER_NAME}})); if(typeof window.onMobileStart==='function') window.onMobileStart(PLAYER_NAME); };
    }
    window.getPlayerNickname=()=>PLAYER_NAME;
    window.askNicknameEveryRun=()=>openNameModal();
    openNameModal();
  </script>

  <!-- Your game logic -->
  <script src="./game.js"></script>
</body>
</html>
