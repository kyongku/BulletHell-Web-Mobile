<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>BulletHell â€” Mobile</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <header id="topBar">
    <button id="profileBtn" class="profile" title="í”„ë¡œí•„">
      <div class="avatar">ğŸ™‚</div>
      <div class="who">
        <div id="profileName">ë¡œê·¸ì¸ í•„ìš”</div>
        <div class="best">Best: <span id="profileBest">0</span></div>
      </div>
    </button>
    <div class="spacer"></div>
    <div class="goldBox">Gold: <span id="goldText">0</span></div>
    <button id="btnGacha" class="primary">ë½‘ê¸°(100G)</button>
    <button id="btnPatch" class="ghost">íŒ¨ì¹˜ë…¸íŠ¸</button>
    <button id="btnRanking" class="ghost">ë­í‚¹</button>
  </header>

  <main id="mainMenu">
    <h1>BulletHell â€” Mobile</h1>
    <p class="muted">350Ã—350 â€¢ ê³„ì •/ë­í‚¹ â€¢ ë³´ìŠ¤ â€¢ ìŠ¤í‚¨ ê°€ì±  â€¢ HUD</p>
    <button id="btnStart" class="primary">ê²Œì„ ì‹œì‘</button>
  </main>

  <section id="gameWrap" class="hidden">
    <div class="top-hud" aria-label="ìƒë‹¨ HUD">
      <div class="hpbar" role="progressbar" aria-valuemin="0">
        <div id="hpFill" class="hp-fill"></div>
      </div>
      <div class="hptext" id="hpText">100 / 100</div>
      <div class="score-wrap">Score: <span id="liveScore">0</span></div>
    </div>

    <canvas id="gameCanvas" width="350" height="350" aria-label="ê²Œì„ ë³´ë“œ"></canvas>

    <div id="hudBar">
      <div id="pad" class="pad" role="group" aria-label="ì¡°ì´ìŠ¤í‹±">
        <div id="stick" class="stick"></div>
      </div>
    </div>
  </section>

  <!-- ê²Œì„ì˜¤ë²„ -->
  <div id="over" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h2 style="margin:0 0 6px 0;">ê²Œì„ ì˜¤ë²„</h2>
      <div class="muted">ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span></div>
      <div class="row actions">
        <button id="btnToMenu" class="secondary">ë©”ì¸ í™”ë©´</button>
        <button id="btnSaveRank" class="primary">ë­í‚¹ ì…ë ¥</button>
      </div>
      <div id="saveToast" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- ë‹‰ë„¤ì„ ì„¤ì • -->
  <div id="nickModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">ë‹‰ë„¤ì„ ì„¤ì •</h3>
      <p class="muted">í•œê¸€/ì˜ë¬¸/ìˆ«ì 2~12ì. ìµœì´ˆ 1íšŒë§Œ ì„¤ì •.</p>
      <input id="nickInput" type="text" maxlength="12" placeholder="ì˜ˆ: ê²½êµ¬" />
      <div class="row actions">
        <button id="btnNickSave" class="primary">ì €ì¥</button>
      </div>
      <div id="nickMsg" class="muted"></div>
    </div>
  </div>

  <!-- í”„ë¡œí•„/ìŠ¤í‚¨ ì„ íƒ -->
  <div id="profileModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">í”„ë¡œí•„</h3>
      <div class="muted" id="profInfo">ë‹‰ë„¤ì„ / ìµœê³ ì  / Gold</div>
      <h4 style="margin:10px 0 6px 0;">ìŠ¤í‚¨ ì„ íƒ</h4>
      <div id="skinGrid" class="skin-grid"></div>
      <div class="row actions" style="margin-top:10px;">
        <button id="btnProfileClose" class="ghost">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ê°€ì±  -->
  <div id="gachaModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">ë½‘ê¸° (100 Gold)</h3>
      <div class="muted">í™•ë¥ : N 70% / R 20% / E 7.5% / L 2% / GOD 0.5%</div>
      <div id="gachaResult" class="gacha-result muted" style="min-height:24px;margin:8px 0 6px 0;"></div>
      <div class="row actions">
        <button id="btnDoGacha" class="primary">ë½‘ê¸°í•˜ê¸°</button>
        <button id="btnGachaClose" class="ghost">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- íŒ¨ì¹˜ë…¸íŠ¸ -->
  <div id="patchModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">íŒ¨ì¹˜ë…¸íŠ¸</h3>
      <div id="patchList" class="patchlist"></div>
      <div class="row actions">
        <button id="btnPatchClose" class="ghost">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supa = createClient(
      'https://pecoerlqanocydrdovbb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlY29lcmxxYW5vY3lkcmRvdmJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzM4ODYsImV4cCI6MjA3MDc0OTg4Nn0.gbQlIPV89_IecGzfVxsnjuzLe-TStTYQqMKzV-B4CUs'
    );

    // --------- ìœ í‹¸/ìƒíƒœ ----------
    const $ = (s)=>document.querySelector(s);
    const show = (el)=>el.classList.remove('hidden');
    const hide = (el)=>el.classList.add('hidden');
    const genTag4 = () => String(Math.floor(1000 + Math.random()*9000));

    let currentUser = null;
    let profile = null;       // { user_id, nickname, tag, gold, selected_skin, unlocked_skins }
    let bestScore = 0;

    const ALL_SKINS = [
      // Normal (ë‹¨ìƒ‰)
      { id:'white',   name:'White',   grade:'N' },
      { id:'mint',    name:'Mint',    grade:'N' },
      { id:'sky',     name:'Sky',     grade:'N' },
      { id:'lime',    name:'Lime',    grade:'N' },
      { id:'orange',  name:'Orange',  grade:'N' },
      { id:'violet',  name:'Violet',  grade:'N' },
      { id:'aqua',    name:'Aqua',    grade:'N' },
      // Rare (ìŠ¤íŠ¸ë¼ì´í”„ 2ìƒ‰)
      { id:'stripe-mint-sky',  name:'Stripe Mint/Sky',  grade:'R' },
      { id:'stripe-orange-violet', name:'Stripe Orange/Violet', grade:'R' },
      // Epic (ê·¸ë¼ë””ì–¸íŠ¸ 2~3ìƒ‰)
      { id:'grad-sunrise', name:'Grad Sunrise', grade:'E' },
      { id:'grad-sea',     name:'Grad Sea',     grade:'E' },
      // Legendary (ê¸ˆ/ì€ ìŠ¤íŠ¸ë¦½, ì„ ì…‹)
      { id:'stripe-gold-silver', name:'Stripe Gold/Silver', grade:'L' },
      { id:'grad-sunset',        name:'Grad Sunset',        grade:'L' },
      // GOD (ë¬´ì§€ê°œ)
      { id:'god-rainbow', name:'GOD Rainbow', grade:'GOD' }
    ];

    const GRADE_POOL = [
      { grade:'GOD', p:0.005, skins:ALL_SKINS.filter(s=>s.grade==='GOD') },
      { grade:'L',   p:0.02,  skins:ALL_SKINS.filter(s=>s.grade==='L') },
      { grade:'E',   p:0.075, skins:ALL_SKINS.filter(s=>s.grade==='E') },
      { grade:'R',   p:0.20,  skins:ALL_SKINS.filter(s=>s.grade==='R') },
      { grade:'N',   p:0.70,  skins:ALL_SKINS.filter(s=>s.grade==='N') },
    ];

    function pickGacha() {
      const r = Math.random();
      let acc = 0;
      for (const g of GRADE_POOL) {
        acc += g.p;
        if (r <= acc) {
          const arr = g.skins;
          const skin = arr[Math.floor(Math.random()*arr.length)];
          return { grade: g.grade, skin };
        }
      }
      // fallback
      const last = GRADE_POOL[GRADE_POOL.length-1];
      return { grade:last.grade, skin:last.skins[0] };
    }

    // --------- ì´ˆê¸°í™” ----------
    (async () => {
      const { data: { user } } = await supa.auth.getUser();
      if (!user) { location.href = './login.html'; return; }
      currentUser = user;
      await ensureProfile(user);
      await loadProfile(user);
      await fetchBestScore(user.id);
      applyHeaderUI();
      buildSkinGrid();
      // ê²Œì„ ì½”ë“œì—ì„œ ì½ì„ ì„¤ì • ì „ë‹¬
      window.GameConfig = {
        get selectedSkin(){ return profile?.selected_skin || 'white'; }
      };
    })();

    async function ensureProfile(user){
      const { data: p } = await supa.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      if (p) return;
      show($('#nickModal'));
      await new Promise(resolve=>{
        $('#btnNickSave').onclick = async ()=>{
          const name = $('#nickInput').value.trim();
          if (!name || name.length < 2) { $('#nickMsg').textContent = '2~12ì ë‹‰ë„¤ì„ ì…ë ¥'; return; }
          let tag = genTag4(), tries=0, ok=false;
          while(!ok && tries<8){
            const { data:t } = await supa.from('profiles').select('user_id').eq('nickname', name).eq('tag', tag).maybeSingle();
            if (!t) ok = true; else { tag = genTag4(); tries++; }
          }
          const row = {
            user_id: user.id, nickname: name, tag,
            gold: 0, selected_skin: 'white', unlocked_skins: ['white']
          };
          const { error } = await supa.from('profiles').insert([row]);
          if (error){ $('#nickMsg').textContent = 'ì‹¤íŒ¨: '+error.message; return; }
          hide($('#nickModal')); resolve();
        };
      });
    }

    async function loadProfile(user){
      const { data } = await supa.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      profile = data;
      // ì»¬ëŸ¼ ì—†ê±°ë‚˜ nullì¸ ì˜ˆì „ ë ˆì½”ë“œ ë³´ì •
      const patch = {};
      if (profile.gold == null) patch.gold = 0;
      if (!profile.selected_skin) patch.selected_skin = 'white';
      if (!Array.isArray(profile.unlocked_skins)) patch.unlocked_skins = ['white'];
      if (Object.keys(patch).length){
        await supa.from('profiles').update(patch).eq('user_id', user.id);
        Object.assign(profile, patch);
      }
    }

    async function fetchBestScore(uid){
      const { data } = await supa.from('scores').select('score').eq('user_id', uid).order('score', {ascending:false}).limit(1);
      bestScore = (data && data[0]) ? data[0].score : 0;
    }

    function applyHeaderUI(){
      const nameTag = profile.nickname + '#' + profile.tag;
      $('#profileName').textContent = nameTag;
      $('#profileBest').textContent = String(bestScore||0);
      $('#goldText').textContent = profile.gold ?? 0;
    }

    // --------- ëª¨ë‹¬/ë²„íŠ¼ ----------
    $('#btnRanking').onclick = ()=> location.href='./ranking/';
    $('#btnPatch').onclick = async ()=>{
      $('#patchList').textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'; show($('#patchModal'));
      const { data, error } = await supa.from('updates').select('title,content,created_at').order('created_at', {ascending:false}).limit(3);
      if (error) { $('#patchList').textContent='ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+error.message; return; }
      $('#patchList').innerHTML = data.map(u => `
        <article class="note">
          <h4>${u.title}</h4>
          <div class="muted">${new Date(u.created_at).toLocaleString()}</div>
          <p>${u.content}</p>
        </article>
      `).join('');
    };
    $('#btnPatchClose').onclick = ()=> hide($('#patchModal'));

    $('#btnStart').onclick = ()=>{
      hide($('#mainMenu')); show($('#gameWrap'));
      window.startGame && window.startGame();
    };

    $('#profileBtn').onclick = ()=>{
      updateProfileModalUI();
      show($('#profileModal'));
    };
    $('#btnProfileClose').onclick = ()=> hide($('#profileModal'));

    $('#btnGacha').onclick = ()=>{
      $('#gachaResult').textContent = '';
      show($('#gachaModal'));
    };
    $('#btnGachaClose').onclick = ()=> hide($('#gachaModal'));
    $('#btnDoGacha').onclick = async ()=>{
      if ((profile.gold ?? 0) < 100){
        $('#gachaResult').textContent = 'Goldê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.';
        return;
      }
      const { grade, skin } = pickGacha();
      // ì°¨ê° & ì§€ê¸‰
      const newGold = (profile.gold ?? 0) - 100;
      const set = new Set(profile.unlocked_skins || []);
      set.add(skin.id);
      const newUnlocked = Array.from(set);
      const updates = { gold:newGold, unlocked_skins:newUnlocked };
      // ê³ ë“±ê¸‰ì´ë©´ ìë™ ì„ íƒë„ ê°€ëŠ¥í•˜ì§€ë§Œ, ì—¬ê¸°ì„  ìœ ì§€
      const { error } = await supa.from('profiles').update(updates).eq('user_id', profile.user_id);
      if (error){ $('#gachaResult').textContent = 'ì˜¤ë¥˜: '+error.message; return; }
      Object.assign(profile, updates);
      applyHeaderUI(); buildSkinGrid(); updateProfileModalUI();
      $('#gachaResult').textContent = `ë‹¹ì²¨! [${grade}] ${skin.name}`;
    };

    // --------- í”„ë¡œí•„/ìŠ¤í‚¨ UI ----------
    function gradeBadge(g){
      const map={N:'N', R:'R', E:'E', L:'L', GOD:'G'};
      return `<span class="badge g-${g}">${map[g]||g}</span>`;
    }

    function buildSkinGrid(){
      const grid = $('#skinGrid');
      const have = new Set(profile.unlocked_skins||['white']);
      grid.innerHTML = ALL_SKINS.map(s=>{
        const owned = have.has(s.id);
        const sel = profile.selected_skin === s.id;
        return `
          <button class="chip ${owned?'':'chip-lock'} ${sel?'chip-sel':''}" data-id="${s.id}">
            <span class="chip-color" data-skin="${s.id}"></span>
            <span>${s.name}</span>
            ${gradeBadge(s.grade)}
          </button>`;
      }).join('');
      grid.querySelectorAll('button.chip').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-id');
          if (!have.has(id)) return;
          if (profile.selected_skin === id) return;
          const { error } = await supa.from('profiles').update({ selected_skin:id }).eq('user_id', profile.user_id);
          if (error) return;
          profile.selected_skin = id;
          buildSkinGrid();
        };
      });
      // ì¹© ìƒ‰(í”„ë¦¬ë·°) ìŠ¤íƒ€ì¼ ë°˜ì˜
      grid.querySelectorAll('.chip-color').forEach(span=>{
        const id = span.getAttribute('data-skin');
        span.style.background = previewCSS(id);
      });
    }

    function updateProfileModalUI(){
      $('#profInfo').textContent = `${profile.nickname}#${profile.tag} / Best ${bestScore} / Gold ${profile.gold}`;
    }

    function previewCSS(id){
      switch(id){
        case 'white': return '#ffffff';
        case 'mint': return '#7ef5d1';
        case 'sky': return '#7ecbff';
        case 'lime': return '#a6ff6b';
        case 'orange': return '#ffb36b';
        case 'violet': return '#ba8bff';
        case 'aqua': return '#6bfffb';
        case 'stripe-mint-sky': return 'repeating-linear-gradient(45deg,#7ef5d1 0 8px,#7ecbff 8px 16px)';
        case 'stripe-orange-violet': return 'repeating-linear-gradient(45deg,#ffb36b 0 8px,#ba8bff 8px 16px)';
        case 'grad-sunrise': return 'linear-gradient(90deg,#ff9a9e,#fad0c4,#ffd1ff)';
        case 'grad-sea': return 'linear-gradient(90deg,#36d1dc,#5b86e5)';
        case 'stripe-gold-silver': return 'repeating-linear-gradient(45deg,#ffd700 0 8px,#c0c0c0 8px 16px)';
        case 'grad-sunset': return 'linear-gradient(90deg,#0b486b,#f56217)';
        case 'god-rainbow': return 'linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)';
        default: return '#ffffff';
      }
    }

    // --------- ê²Œì„ê³¼ ìƒí˜¸ì‘ìš© ----------
    window.GameInterop = {
      async saveScore(score){
        const { data: { user } } = await supa.auth.getUser();
        if (!user) return { ok:false, reason:'ë¡œê·¸ì¸ í•„ìš”' };
        const payload = { user_id: user.id, score: Math.floor(score) };
        const { error } = await supa.from('scores').insert([payload]);
        if (error) return { ok:false, reason:error.message };
        await fetchBestScore(user.id); applyHeaderUI();
        return { ok:true };
      },
      // ë³´ìŠ¤ í´ë¦¬ì–´: ë³´ìŠ¤ë²ˆí˜¸ n (1,2,3...) â†’ 3ë²ˆì§¸ë¶€í„° ë³´ìƒ
      async onBossClear(n){
        if (n >= 3){
          const add = (n - 2) * 10;
          await addGold(add);
          toast(`Boss ${n} í´ë¦¬ì–´ +${add}G`);
        }
      },
      getSelectedSkin(){
        return profile?.selected_skin || 'white';
      }
    };

    async function addGold(amount){
      const newGold = (profile.gold ?? 0) + amount;
      const { error } = await supa.from('profiles').update({ gold:newGold }).eq('user_id', profile.user_id);
      if (!error){ profile.gold = newGold; $('#goldText').textContent = newGold; updateProfileModalUI(); }
    }

    function toast(msg){
      const t = $('#saveToast');
      t.textContent = msg;
      setTimeout(()=> t.textContent = '', 2500);
    }
  </script>
  <script type="module" src="./game.js"></script>
</body>
</html>
