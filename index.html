<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>BulletHell — Mobile</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* 초기 로딩 오버레이: 로그인 확인 중에 UI 깜빡임 방지 */
    #authGate {
      position: fixed; inset: 0; display: grid; place-items: center;
      background: rgba(0,0,0,.7); color: #e6e6e6; z-index: 9999;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    /* 프로필 모달 하단 버튼 좌/우 배치 */
    #profileModal .row.actions {
      display: flex; justify-content: space-between; align-items: center;
    }
  </style>
</head>
<body>
  <div id="authGate">로그인 확인 중...</div>

  <header id="topBar" class="hidden">
    <button id="profileBtn" class="profile" title="프로필">
      <!-- ▶ 변경: 헤더 아바타에 id 부여(선택 이모지 동기화 대상) -->
      <div class="avatar" id="profileEmoji">⭐</div>
      <div class="who">
        <div id="profileName">로그인 필요</div>
        <div class="best">Best: <span id="profileBest">0</span></div>
      </div>
    </button>
    <div class="spacer"></div>
    <div class="goldBox">Gold: <span id="goldText">0</span></div>
    <button id="btnGacha" class="primary">뽑기(100G)</button>
    <button id="btnPatch" class="ghost">패치노트</button>
    <button id="btnRanking" class="ghost">랭킹</button>
    <!-- ▶ 추가: 이모지 상점 버튼(메인에서만 노출) -->
    <button id="btnEmojiShop" class="ghost">이모지 상점</button>
  </header>

  <main id="mainMenu" class="hidden">
    <h1>BulletHell — Mobile</h1>
    <p class="muted">350×350 • 계정/랭킹 • 보스 • 스킨 가챠 • HUD</p>
    <button id="btnStart" class="primary">게임 시작</button>
  </main>

  <section id="gameWrap" class="hidden">
    <div class="top-hud" aria-label="상단 HUD">
      <div class="hpbar" role="progressbar" aria-valuemin="0">
        <div id="hpFill" class="hp-fill"></div>
      </div>
      <div class="hptext" id="hpText">100 / 100</div>
      <div class="score-wrap">Score: <span id="liveScore">0</span></div>
    </div>

    <canvas id="gameCanvas" width="350" height="350" aria-label="게임 보드"></canvas>

    <div id="hudBar">
      <div id="pad" class="pad" role="group" aria-label="조이스틱">
        <div id="stick" class="stick"></div>
      </div>
    </div>
  </section>

  <!-- 게임오버 -->
  <div id="over" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h2 style="margin:0 0 6px 0;">게임 오버</h2>
      <div class="muted">최종 점수: <span id="finalScore">0</span></div>
      <div class="row actions">
        <button id="btnToMenu" class="secondary">메인 화면</button>
        <button id="btnSaveRank" class="primary">랭킹 입력</button>
      </div>
      <div id="saveToast" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- 닉네임 설정 -->
  <div id="nickModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">닉네임 설정</h3>
      <p class="muted">한글/영문/숫자 2~12자. 최초 1회만 설정.</p>
      <input id="nickInput" type="text" maxlength="12" placeholder="예: 홍길동" />
      <div class="row actions">
        <button id="btnNickSave" class="primary">저장</button>
      </div>
      <div id="nickMsg" class="muted"></div>
    </div>
  </div>

  <!-- 프로필/스킨 + ▶ 추가: 이모지 선택 -->
  <div id="profileModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">프로필</h3>
      <div class="muted" id="profInfo">닉네임 / 최고점 / Gold</div>

      <h4 style="margin:10px 0 6px 0;">스킨 선택</h4>
      <div id="skinGrid" class="skin-grid"></div>

      <!-- ▶ 추가: 이모지 선택 섹션 -->
      <h4 style="margin:10px 0 6px 0;">이모지 선택</h4>
      <div id="emojiGrid" class="skin-grid"></div>
      <p class="muted">이모지는 상점/뽑기로 해금 후 선택할 수 있어요.</p>

      <div class="row actions" style="margin-top:10px;">
        <button id="btnProfileClose" class="ghost">닫기</button>
        <button id="btnLogout" class="secondary">로그아웃</button>
      </div>
    </div>
  </div>

  <!-- 가챠 -->
  <div id="gachaModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">뽑기 (100 Gold)</h3>
      <div class="muted">확률: N 80% / R 15% / E 4.45% / L 0.45% / GOD 0.05%</div>
      <div id="gachaResult" class="gacha-result muted" style="min-height:24px;margin:8px 0 6px 0;"></div>
      <div class="row actions">
        <button id="btnDoGacha" class="primary">뽑기하기</button>
        <button id="btnGachaClose" class="ghost">닫기</button>
      </div>
    </div>
  </div>

  <!-- 패치노트 -->
  <div id="patchModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">패치노트</h3>
      <div id="patchList" class="patchlist"></div>
      <div class="row actions">
        <button id="btnPatchClose" class="ghost">닫기</button>
      </div>
    </div>
  </div>

  <!-- ▶ 추가: 이모지 상점(메인 전용) -->
  <div id="emojiShopModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">이모지 상점</h3>
      <div id="emojiShopGrid" class="emoji-shop"></div>
      <div class="row actions" style="margin-top:10px;">
        <div class="muted">보유 골드: <span id="shopGold">0</span></div>
        <button id="btnEmojiShopClose" class="ghost">닫기</button>
      </div>
    </div>
  </div>

  <!-- ★ 전역 주입: game.js보다 먼저 로드되어야 함 -->
  <script type="module">
    import * as supabase from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    window.supabase = supabase;
  </script>

  <!-- 페이지 로직 (세션: sessionStorage) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supa = createClient(
      'https://pecoerlqanocydrdovbb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlY29lcmxxYW5vY3lkcmRvdmJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzM4ODYsImV4cCI6MjA3MDc0OTg4Nn0.gbQlIPV89_IecGzfVxsnjuzLe-TStTYQqMKzV-B4CUs',
      { auth: { persistSession: true, autoRefreshToken: true, storage: window.sessionStorage } }
    );

    const $ = (s)=>document.querySelector(s);
    const show = (el)=>el.classList.remove('hidden');
    const hide = (el)=>el.classList.add('hidden');
    const genTag4 = () => String(Math.floor(1000 + Math.random()*9000));

    let currentUser = null, profile = null, bestScore = 0;

    // ---------- 로그인 확인 & 초기화 ----------
    (async () => {
      await new Promise(r=>setTimeout(r, 60)); // 모듈/세션 동기화 대기
      const { data: { user } } = await supa.auth.getUser();
      if (!user) { location.href = './login.html'; return; }  // 미로그인 → 로그인 페이지
      currentUser = user;

      await ensureProfile(user);
      await loadProfile(user);

      // RPC에서 현재 총 골드 읽어와서 profiles/헤더에 반영
      try {
        const { data: total, error: terr } = await supa.rpc('wallet_add_gold', { delta: 0 });
        if (!terr && typeof total === 'number') {
          await supa.from('profiles').update({ gold: total }).eq('user_id', currentUser.id);
          profile.gold = total;
        }
      } catch (_) {}

      await fetchBestScore(user.id);
      applyHeaderUI();
      buildSkinGrid();

      // ▶ 추가: 이모지 그리드/상점 준비
      buildEmojiGrid();
      // window.GameConfig.selectedSkin 유지
      window.GameConfig = { get selectedSkin(){ return profile?.selected_skin || 'white'; } };

      // UI 표시
      document.getElementById('authGate')?.remove();
      show(document.getElementById('topBar'));
      show(document.getElementById('mainMenu'));
    })();

    // ---------- 스킨/가챠 데이터 ----------
    const ALL_SKINS = [
      // N
      { id:'white', name:'White', grade:'N' },{ id:'mint', name:'Mint', grade:'N' },
      { id:'sky', name:'Sky', grade:'N' },{ id:'lime', name:'Lime', grade:'N' },
      { id:'orange', name:'Orange', grade:'N' },{ id:'violet', name:'Violet', grade:'N' },
      { id:'aqua', name:'Aqua', grade:'N' },
      // R
      { id:'stripe-mint-sky', name:'Stripe Mint/Sky', grade:'R' },
      { id:'stripe-orange-violet', name:'Stripe Orange/Violet', grade:'R' },
      // E
      { id:'grad-sunrise', name:'Grad Sunrise', grade:'E' },
      { id:'grad-sea',     name:'Grad Sea',     grade:'E' },
      // L
      { id:'stripe-gold-silver', name:'Stripe Gold/Silver', grade:'L' },
      { id:'grad-sunset',        name:'Grad Sunset',        grade:'L' },
      // GOD
      { id:'god-rainbow', name:'GOD Rainbow', grade:'GOD' }
    ];
    const GRADE_POOL = [
      { grade:'GOD', p:0.005, skins:ALL_SKINS.filter(s=>s.grade==='GOD') },
      { grade:'L',   p:0.02,  skins:ALL_SKINS.filter(s=>s.grade==='L') },
      { grade:'E',   p:0.075, skins:ALL_SKINS.filter(s=>s.grade==='E') },
      { grade:'R',   p:0.20,  skins:ALL_SKINS.filter(s=>s.grade==='R') },
      { grade:'N',   p:0.70,  skins:ALL_SKINS.filter(s=>s.grade==='N') },
    ];
    function pickGacha(){
      const r=Math.random(); let acc=0;
      for(const g of GRADE_POOL){ acc+=g.p; if(r<=acc){ const arr=g.skins; return { grade:g.grade, skin:arr[Math.floor(Math.random()*arr.length)] }; } }
      const last=GRADE_POOL.at(-1); return { grade:last.grade, skin:last.skins[0] };
    }
    function gradeBadge(g){ const map={N:'N', R:'R', E:'E', L:'L', GOD:'G'}; return `<span class="badge g-${g}">${map[g]||g}</span>`; }
    function previewCSS(id){
      switch(id){
        case 'white': return '#ffffff'; case 'mint': return '#7ef5d1'; case 'sky': return '#7ecbff';
        case 'lime': return '#a6ff6b'; case 'orange': return '#ffb36b'; case 'violet': return '#ba8bff'; case 'aqua': return '#6bfffb';
        case 'stripe-mint-sky': return 'repeating-linear-gradient(45deg,#7ef5d1 0 8px,#7ecbff 8px 16px)';
        case 'stripe-orange-violet': return 'repeating-linear-gradient(45deg,#ffb36b 0 8px,#ba8bff 8px 16px)';
        case 'grad-sunrise': return 'linear-gradient(90deg,#ff9a9e,#fad0c4,#ffd1ff)';
        case 'grad-sea': return 'linear-gradient(90deg,#36d1dc,#5b86e5)';
        case 'stripe-gold-silver': return 'repeating-linear-gradient(45deg,#ffd700 0 8px,#c0c0c0 8px 16px)';
        case 'grad-sunset': return 'linear-gradient(90deg,#0b486b,#f56217)';
        case 'god-rainbow': return 'linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)';
        default: return '#ffffff';
      }
    }

    // ---------- 프로필/스킨 UI ----------
    function buildSkinGrid(){
      const grid = document.getElementById('skinGrid');
      const have = new Set(profile.unlocked_skins||['white']);
      grid.innerHTML = ALL_SKINS.map(s=>{
        const owned = have.has(s.id);
        const sel = profile.selected_skin === s.id;
        return `
          <button class="chip ${owned?'':'chip-lock'} ${sel?'chip-sel':''}" data-id="${s.id}">
            <span class="chip-color" data-skin="${s.id}"></span>
            <span>${s.name}</span>
            ${gradeBadge(s.grade)}
          </button>`;
      }).join('');
      grid.querySelectorAll('button.chip').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-id');
          if (!have.has(id)) return;
          if (profile.selected_skin === id) return;
          const { error } = await supa.from('profiles').update({ selected_skin:id }).eq('user_id', profile.user_id);
          if (!error){ profile.selected_skin = id; buildSkinGrid(); }
        };
      });
      grid.querySelectorAll('.chip-color').forEach(span=>{
        const id = span.getAttribute('data-skin');
        span.style.background = previewCSS(id);
      });
    }
    function updateProfileModalUI(){
      document.getElementById('profInfo').textContent =
        `${profile.nickname}#${profile.tag} / Best ${bestScore} / Gold ${profile.gold}`;
    }

    // ---------- 계정/베스트스코어 ----------
    async function ensureProfile(user){
      const { data: p } = await supa.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      if (p) return;
      document.getElementById('nickModal').classList.remove('hidden');
      await new Promise(resolve=>{
        document.getElementById('btnNickSave').onclick = async ()=>{
          const name = document.getElementById('nickInput').value.trim();
          if (!name || name.length < 2) { document.getElementById('nickMsg').textContent = '2~12자 닉네임 입력'; return; }
          let tag = genTag4(), tries=0, ok=false;
          while(!ok && tries<8){
            const { data:t } = await supa.from('profiles').select('user_id').eq('nickname', name).eq('tag', tag).maybeSingle();
            if (!t) ok = true; else { tag = genTag4(); tries++; }
          }
          const row = { user_id: user.id, nickname: name, tag, gold: 0, selected_skin: 'white', unlocked_skins: ['white'],
                        /* ▶ 추가: 이모지 기본값 */ selected_emoji:'⭐', unlocked_emojis:['⭐'] };
          const { error } = await supa.from('profiles').insert([row]);
          if (error){ document.getElementById('nickMsg').textContent = '실패: '+error.message; return; }
          document.getElementById('nickModal').classList.add('hidden');
          resolve();
        };
      });
    }
    async function loadProfile(user){
      const { data } = await supa.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      profile = data || {};
      const patch = {};
      if (profile.gold == null) patch.gold = 0;
      if (!profile.selected_skin) patch.selected_skin = 'white';
      if (!Array.isArray(profile.unlocked_skins)) patch.unlocked_skins = ['white'];
      // ▶ 추가: 이모지 필드 보정
      if (!profile.selected_emoji) patch.selected_emoji = '⭐';
      if (!Array.isArray(profile.unlocked_emojis)) patch.unlocked_emojis = ['⭐'];
      if (Object.keys(patch).length){
        await supa.from('profiles').update(patch).eq('user_id', user.id);
        Object.assign(profile, patch);
      }
    }
    async function fetchBestScore(uid){
      const { data } = await supa.from('scores').select('score').eq('user_id', uid).order('score', {ascending:false}).limit(1);
      bestScore = (data && data[0]) ? data[0].score : 0;
    }
    function applyHeaderUI(){
      const nameTag = (profile.nickname||'user') + '#' + (profile.tag||'0000');
      document.getElementById('profileName').textContent = nameTag;
      document.getElementById('profileBest').textContent = String(bestScore||0);
      document.getElementById('goldText').textContent = profile.gold ?? 0;
      // ▶ 추가: 헤더 이모지 반영
      document.getElementById('profileEmoji').textContent = profile.selected_emoji || '⭐';
    }

    // ---------- ▶ 추가: 이모지 카탈로그 & UI/구매 ----------
    const EMOJI_STORE = [
      { id:'e_star',   emoji:'⭐', name:'Star',   price:  0 }, // 기본 무료
      { id:'e_smile',  emoji:'😄', name:'Smile',  price: 60 },
      { id:'e_fire',   emoji:'🔥', name:'Fire',   price:120 },
      { id:'e_crown',  emoji:'👑', name:'Crown',  price:180 },
      { id:'e_rocket', emoji:'🚀', name:'Rocket', price:200 },
      { id:'e_skull',  emoji:'💀', name:'Skull',  price:200 },
      { id:'e_dragon', emoji:'🐉', name:'Dragon', price:260 },
      { id:'e_trophy', emoji:'🏆', name:'Trophy', price:300 }
    ];

    function buildEmojiGrid(){
      const grid = document.getElementById('emojiGrid');
      if (!grid) return;
      const have = new Set(profile.unlocked_emojis || ['⭐']);
      const selected = profile.selected_emoji || '⭐';
      grid.innerHTML = EMOJI_STORE.map(e=>{
        const owned = have.has(e.emoji) || e.price===0;
        const sel = selected === e.emoji;
        return `
          <button class="chip ${owned?'':'chip-lock'} ${sel?'chip-sel':''}" data-emoji="${e.emoji}">
            <span class="chip-color" style="display:grid;place-items:center;font-size:16px;background:#1a2332">${e.emoji}</span>
            <span>${e.name}</span>
          </button>`;
      }).join('');
      grid.querySelectorAll('[data-emoji]').forEach(btn=>{
        btn.onclick = async ()=>{
          const pick = btn.getAttribute('data-emoji');
          if (!have.has(pick) && pick!=='⭐') return;
          if (profile.selected_emoji === pick) return;
          const { error } = await supa.from('profiles').update({ selected_emoji: pick }).eq('user_id', profile.user_id);
          if (!error){
            profile.selected_emoji = pick;
            applyHeaderUI();
            buildEmojiGrid();
          }
        };
      });
    }

    function buildEmojiShop(){
      const grid = document.getElementById('emojiShopGrid');
      if (!grid) return;
      const have = new Set(profile.unlocked_emojis || ['⭐']);
      grid.innerHTML = EMOJI_STORE.map(e=>{
        const owned = have.has(e.emoji) || e.price===0;
        return `
          <div class="item">
            <div class="icon">${e.emoji}</div>
            <div class="meta">
              <div class="nm">${e.name}</div>
              <div class="pr">💰 ${e.price}</div>
            </div>
            <button class="buy" data-buy="${e.id}" ${owned?'disabled':''}>${owned?'보유중':'구매'}</button>
          </div>`;
      }).join('');
      grid.querySelectorAll('[data-buy]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-buy');
          const item = EMOJI_STORE.find(x=>x.id===id); if (!item) return;
          const owned = (profile.unlocked_emojis||[]).includes(item.emoji) || item.price===0;
          if (owned) return;

          // 골드 차감
          const { data: newTotal, error: rpcErr } = await supa.rpc('wallet_add_gold', { delta: -item.price });
          if (rpcErr) { toast('골드 차감 실패'); return; }
          profile.gold = (newTotal|0);

          // 보유 이모지 추가
          const next = Array.from(new Set([...(profile.unlocked_emojis||['⭐']), item.emoji]));
          const { error } = await supa.from('profiles').update({ unlocked_emojis: next }).eq('user_id', profile.user_id);
          if (error) { toast('저장 실패'); return; }
          profile.unlocked_emojis = next;

          // UI 갱신
          applyHeaderUI();
          buildEmojiShop();
          buildEmojiGrid();
          toast(`구매 완료: ${item.emoji} ${item.name}`);
        };
      });
    }

    function toast(msg){
      const el = document.getElementById('saveToast');
      if (el){ el.textContent = msg; setTimeout(()=> el.textContent='', 1800); }
    }

    // ---------- 버튼들 ----------
    document.getElementById('btnRanking').onclick = ()=> location.href='./ranking/';
    document.getElementById('btnPatch').onclick = async ()=>{
      document.getElementById('patchList').textContent='불러오는 중...';
      const { data, error } = await supa.from('updates').select('title,content,created_at').order('created_at', {ascending:false}).limit(3);
      if (error) { document.getElementById('patchList').textContent='불러오기 실패: '+error.message; return; }
      document.getElementById('patchList').innerHTML = data.map(u => `
        <article class="note">
          <h4>${u.title}</h4>
          <div class="muted">${new Date(u.created_at).toLocaleString()}</div>
          <p>${u.content}</p>
        </article>
      `).join('');
      document.getElementById('patchModal').classList.remove('hidden');
    };
    document.getElementById('btnPatchClose').onclick = ()=> document.getElementById('patchModal').classList.add('hidden');

    document.getElementById('btnStart').onclick = ()=>{
      document.getElementById('mainMenu').classList.add('hidden');
      document.getElementById('gameWrap').classList.remove('hidden');
      // ▶ 추가: 메인 전용 헤더 숨김(게임 중엔 보이지 않게)
      document.getElementById('topBar').classList.add('hidden');
      window.startGame && window.startGame();
    };

    document.getElementById('profileBtn').onclick = ()=>{
      updateProfileModalUI();
      buildEmojiGrid(); // 최신 보유/선택 반영
      document.getElementById('profileModal').classList.remove('hidden');
    };
    document.getElementById('btnProfileClose').onclick = ()=> document.getElementById('profileModal').classList.add('hidden');

    // 로그아웃(프로필 모달 오른쪽 아래)
    document.getElementById('btnLogout').onclick = async ()=>{
      try { await supa.auth.signOut(); } catch(_){}
      sessionStorage.clear();
      location.href = './login.html';
    };

    document.getElementById('btnGacha').onclick = ()=>{
      document.getElementById('gachaResult').textContent = '';
      document.getElementById('gachaModal').classList.remove('hidden');
    };
    document.getElementById('btnGachaClose').onclick = ()=> document.getElementById('gachaModal').classList.add('hidden');
    document.getElementById('btnDoGacha').onclick = async ()=>{
      if ((profile.gold ?? 0) < 100){
        document.getElementById('gachaResult').textContent = 'Gold가 부족합니다.';
        return;
      }
      const { grade, skin } = pickGacha();
      const newGold = (profile.gold ?? 0) - 100;
      const set = new Set(profile.unlocked_skins || []);
      set.add(skin.id);
      const updates = { gold:newGold, unlocked_skins:Array.from(set) };
      const { error } = await supa.from('profiles').update(updates).eq('user_id', profile.user_id);
      if (error){ document.getElementById('gachaResult').textContent = '오류: '+error.message; return; }
      Object.assign(profile, updates);
      applyHeaderUI(); buildSkinGrid(); updateProfileModalUI(); buildEmojiGrid();
      document.getElementById('gachaResult').textContent = `당첨! [${grade}] ${skin.name}`;
    };

    // ▶ 추가: 이모지 상점 열기/닫기
    document.getElementById('btnEmojiShop').onclick = ()=>{
      document.getElementById('shopGold').textContent = profile?.gold ?? 0;
      buildEmojiShop();
      document.getElementById('emojiShopModal').classList.remove('hidden');
    };
    document.getElementById('btnEmojiShopClose').onclick = ()=>{
      document.getElementById('emojiShopModal').classList.add('hidden');
    };
  </script>

  <!-- game.js: window.supabase 사용 (위 전역 주입 이후 로드) -->
  <script type="module" src="./game.js"></script>
</body>
</html>
