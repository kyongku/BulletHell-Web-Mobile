<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>BulletHell — Mobile</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <header id="topBar">
    <button id="profileBtn" class="profile" title="프로필">
      <div class="avatar">🙂</div>
      <div class="who">
        <div id="profileName">로그인 필요</div>
        <div class="best">Best: <span id="profileBest">0</span></div>
      </div>
    </button>
    <div class="spacer"></div>
    <div class="goldBox">Gold: <span id="goldText">0</span></div>
    <button id="btnGacha" class="primary">뽑기(100G)</button>
    <button id="btnPatch" class="ghost">패치노트</button>
    <button id="btnRanking" class="ghost">랭킹</button>
  </header>

  <main id="mainMenu">
    <h1>BulletHell — Mobile</h1>
    <p class="muted">350×350 • 계정/랭킹 • 보스 • 스킨 가챠 • HUD</p>
    <button id="btnStart" class="primary">게임 시작</button>
  </main>

  <section id="gameWrap" class="hidden">
    <div class="top-hud" aria-label="상단 HUD">
      <div class="hpbar" role="progressbar" aria-valuemin="0">
        <div id="hpFill" class="hp-fill"></div>
      </div>
      <div class="hptext" id="hpText">100 / 100</div>
      <div class="score-wrap">Score: <span id="liveScore">0</span></div>
    </div>

    <canvas id="gameCanvas" width="350" height="350" aria-label="게임 보드"></canvas>

    <div id="hudBar">
      <div id="pad" class="pad" role="group" aria-label="조이스틱">
        <div id="stick" class="stick"></div>
      </div>
    </div>
  </section>

  <!-- 게임오버 -->
  <div id="over" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h2 style="margin:0 0 6px 0;">게임 오버</h2>
      <div class="muted">최종 점수: <span id="finalScore">0</span></div>
      <div class="row actions">
        <button id="btnToMenu" class="secondary">메인 화면</button>
        <button id="btnSaveRank" class="primary">랭킹 입력</button>
      </div>
      <div id="saveToast" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- 닉네임 설정 -->
  <div id="nickModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">닉네임 설정</h3>
      <p class="muted">한글/영문/숫자 2~12자. 최초 1회만 설정.</p>
      <input id="nickInput" type="text" maxlength="12" placeholder="예: 경구" />
      <div class="row actions">
        <button id="btnNickSave" class="primary">저장</button>
      </div>
      <div id="nickMsg" class="muted"></div>
    </div>
  </div>

  <!-- 프로필/스킨 선택 -->
  <div id="profileModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">프로필</h3>
      <div class="muted" id="profInfo">닉네임 / 최고점 / Gold</div>
      <h4 style="margin:10px 0 6px 0;">스킨 선택</h4>
      <div id="skinGrid" class="skin-grid"></div>
      <div class="row actions" style="margin-top:10px;">
        <button id="btnProfileClose" class="ghost">닫기</button>
      </div>
    </div>
  </div>

  <!-- 가챠 -->
  <div id="gachaModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">뽑기 (100 Gold)</h3>
      <div class="muted">확률: N 70% / R 20% / E 7.5% / L 2% / GOD 0.5%</div>
      <div id="gachaResult" class="gacha-result muted" style="min-height:24px;margin:8px 0 6px 0;"></div>
      <div class="row actions">
        <button id="btnDoGacha" class="primary">뽑기하기</button>
        <button id="btnGachaClose" class="ghost">닫기</button>
      </div>
    </div>
  </div>

  <!-- 패치노트 -->
  <div id="patchModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">패치노트</h3>
      <div id="patchList" class="patchlist"></div>
      <div class="row actions">
        <button id="btnPatchClose" class="ghost">닫기</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supa = createClient(
      'https://pecoerlqanocydrdovbb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlY29lcmxxYW5vY3lkcmRvdmJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzM4ODYsImV4cCI6MjA3MDc0OTg4Nn0.gbQlIPV89_IecGzfVxsnjuzLe-TStTYQqMKzV-B4CUs'
    );

    // --------- 유틸/상태 ----------
    const $ = (s)=>document.querySelector(s);
    const show = (el)=>el.classList.remove('hidden');
    const hide = (el)=>el.classList.add('hidden');
    const genTag4 = () => String(Math.floor(1000 + Math.random()*9000));

    let currentUser = null;
    let profile = null;       // { user_id, nickname, tag, gold, selected_skin, unlocked_skins }
    let bestScore = 0;

    const ALL_SKINS = [
      // Normal (단색)
      { id:'white',   name:'White',   grade:'N' },
      { id:'mint',    name:'Mint',    grade:'N' },
      { id:'sky',     name:'Sky',     grade:'N' },
      { id:'lime',    name:'Lime',    grade:'N' },
      { id:'orange',  name:'Orange',  grade:'N' },
      { id:'violet',  name:'Violet',  grade:'N' },
      { id:'aqua',    name:'Aqua',    grade:'N' },
      // Rare (스트라이프 2색)
      { id:'stripe-mint-sky',  name:'Stripe Mint/Sky',  grade:'R' },
      { id:'stripe-orange-violet', name:'Stripe Orange/Violet', grade:'R' },
      // Epic (그라디언트 2~3색)
      { id:'grad-sunrise', name:'Grad Sunrise', grade:'E' },
      { id:'grad-sea',     name:'Grad Sea',     grade:'E' },
      // Legendary (금/은 스트립, 선셋)
      { id:'stripe-gold-silver', name:'Stripe Gold/Silver', grade:'L' },
      { id:'grad-sunset',        name:'Grad Sunset',        grade:'L' },
      // GOD (무지개)
      { id:'god-rainbow', name:'GOD Rainbow', grade:'GOD' }
    ];

    const GRADE_POOL = [
      { grade:'GOD', p:0.005, skins:ALL_SKINS.filter(s=>s.grade==='GOD') },
      { grade:'L',   p:0.02,  skins:ALL_SKINS.filter(s=>s.grade==='L') },
      { grade:'E',   p:0.075, skins:ALL_SKINS.filter(s=>s.grade==='E') },
      { grade:'R',   p:0.20,  skins:ALL_SKINS.filter(s=>s.grade==='R') },
      { grade:'N',   p:0.70,  skins:ALL_SKINS.filter(s=>s.grade==='N') },
    ];

    function pickGacha() {
      const r = Math.random();
      let acc = 0;
      for (const g of GRADE_POOL) {
        acc += g.p;
        if (r <= acc) {
          const arr = g.skins;
          const skin = arr[Math.floor(Math.random()*arr.length)];
          return { grade: g.grade, skin };
        }
      }
      // fallback
      const last = GRADE_POOL[GRADE_POOL.length-1];
      return { grade:last.grade, skin:last.skins[0] };
    }

    // --------- 초기화 ----------
    (async () => {
      const { data: { user } } = await supa.auth.getUser();
      if (!user) { location.href = './login.html'; return; }
      currentUser = user;
      await ensureProfile(user);
      await loadProfile(user);
      await fetchBestScore(user.id);
      applyHeaderUI();
      buildSkinGrid();
      // 게임 코드에서 읽을 설정 전달
      window.GameConfig = {
        get selectedSkin(){ return profile?.selected_skin || 'white'; }
      };
    })();

    async function ensureProfile(user){
      const { data: p } = await supa.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      if (p) return;
      show($('#nickModal'));
      await new Promise(resolve=>{
        $('#btnNickSave').onclick = async ()=>{
          const name = $('#nickInput').value.trim();
          if (!name || name.length < 2) { $('#nickMsg').textContent = '2~12자 닉네임 입력'; return; }
          let tag = genTag4(), tries=0, ok=false;
          while(!ok && tries<8){
            const { data:t } = await supa.from('profiles').select('user_id').eq('nickname', name).eq('tag', tag).maybeSingle();
            if (!t) ok = true; else { tag = genTag4(); tries++; }
          }
          const row = {
            user_id: user.id, nickname: name, tag,
            gold: 0, selected_skin: 'white', unlocked_skins: ['white']
          };
          const { error } = await supa.from('profiles').insert([row]);
          if (error){ $('#nickMsg').textContent = '실패: '+error.message; return; }
          hide($('#nickModal')); resolve();
        };
      });
    }

    async function loadProfile(user){
      const { data } = await supa.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      profile = data;
      // 컬럼 없거나 null인 예전 레코드 보정
      const patch = {};
      if (profile.gold == null) patch.gold = 0;
      if (!profile.selected_skin) patch.selected_skin = 'white';
      if (!Array.isArray(profile.unlocked_skins)) patch.unlocked_skins = ['white'];
      if (Object.keys(patch).length){
        await supa.from('profiles').update(patch).eq('user_id', user.id);
        Object.assign(profile, patch);
      }
    }

    async function fetchBestScore(uid){
      const { data } = await supa.from('scores').select('score').eq('user_id', uid).order('score', {ascending:false}).limit(1);
      bestScore = (data && data[0]) ? data[0].score : 0;
    }

    function applyHeaderUI(){
      const nameTag = profile.nickname + '#' + profile.tag;
      $('#profileName').textContent = nameTag;
      $('#profileBest').textContent = String(bestScore||0);
      $('#goldText').textContent = profile.gold ?? 0;
    }

    // --------- 모달/버튼 ----------
    $('#btnRanking').onclick = ()=> location.href='./ranking/';
    $('#btnPatch').onclick = async ()=>{
      $('#patchList').textContent='불러오는 중...'; show($('#patchModal'));
      const { data, error } = await supa.from('updates').select('title,content,created_at').order('created_at', {ascending:false}).limit(3);
      if (error) { $('#patchList').textContent='불러오기 실패: '+error.message; return; }
      $('#patchList').innerHTML = data.map(u => `
        <article class="note">
          <h4>${u.title}</h4>
          <div class="muted">${new Date(u.created_at).toLocaleString()}</div>
          <p>${u.content}</p>
        </article>
      `).join('');
    };
    $('#btnPatchClose').onclick = ()=> hide($('#patchModal'));

    $('#btnStart').onclick = ()=>{
      hide($('#mainMenu')); show($('#gameWrap'));
      window.startGame && window.startGame();
    };

    $('#profileBtn').onclick = ()=>{
      updateProfileModalUI();
      show($('#profileModal'));
    };
    $('#btnProfileClose').onclick = ()=> hide($('#profileModal'));

    $('#btnGacha').onclick = ()=>{
      $('#gachaResult').textContent = '';
      show($('#gachaModal'));
    };
    $('#btnGachaClose').onclick = ()=> hide($('#gachaModal'));
    $('#btnDoGacha').onclick = async ()=>{
      if ((profile.gold ?? 0) < 100){
        $('#gachaResult').textContent = 'Gold가 부족합니다.';
        return;
      }
      const { grade, skin } = pickGacha();
      // 차감 & 지급
      const newGold = (profile.gold ?? 0) - 100;
      const set = new Set(profile.unlocked_skins || []);
      set.add(skin.id);
      const newUnlocked = Array.from(set);
      const updates = { gold:newGold, unlocked_skins:newUnlocked };
      // 고등급이면 자동 선택도 가능하지만, 여기선 유지
      const { error } = await supa.from('profiles').update(updates).eq('user_id', profile.user_id);
      if (error){ $('#gachaResult').textContent = '오류: '+error.message; return; }
      Object.assign(profile, updates);
      applyHeaderUI(); buildSkinGrid(); updateProfileModalUI();
      $('#gachaResult').textContent = `당첨! [${grade}] ${skin.name}`;
    };

    // --------- 프로필/스킨 UI ----------
    function gradeBadge(g){
      const map={N:'N', R:'R', E:'E', L:'L', GOD:'G'};
      return `<span class="badge g-${g}">${map[g]||g}</span>`;
    }

    function buildSkinGrid(){
      const grid = $('#skinGrid');
      const have = new Set(profile.unlocked_skins||['white']);
      grid.innerHTML = ALL_SKINS.map(s=>{
        const owned = have.has(s.id);
        const sel = profile.selected_skin === s.id;
        return `
          <button class="chip ${owned?'':'chip-lock'} ${sel?'chip-sel':''}" data-id="${s.id}">
            <span class="chip-color" data-skin="${s.id}"></span>
            <span>${s.name}</span>
            ${gradeBadge(s.grade)}
          </button>`;
      }).join('');
      grid.querySelectorAll('button.chip').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-id');
          if (!have.has(id)) return;
          if (profile.selected_skin === id) return;
          const { error } = await supa.from('profiles').update({ selected_skin:id }).eq('user_id', profile.user_id);
          if (error) return;
          profile.selected_skin = id;
          buildSkinGrid();
        };
      });
      // 칩 색(프리뷰) 스타일 반영
      grid.querySelectorAll('.chip-color').forEach(span=>{
        const id = span.getAttribute('data-skin');
        span.style.background = previewCSS(id);
      });
    }

    function updateProfileModalUI(){
      $('#profInfo').textContent = `${profile.nickname}#${profile.tag} / Best ${bestScore} / Gold ${profile.gold}`;
    }

    function previewCSS(id){
      switch(id){
        case 'white': return '#ffffff';
        case 'mint': return '#7ef5d1';
        case 'sky': return '#7ecbff';
        case 'lime': return '#a6ff6b';
        case 'orange': return '#ffb36b';
        case 'violet': return '#ba8bff';
        case 'aqua': return '#6bfffb';
        case 'stripe-mint-sky': return 'repeating-linear-gradient(45deg,#7ef5d1 0 8px,#7ecbff 8px 16px)';
        case 'stripe-orange-violet': return 'repeating-linear-gradient(45deg,#ffb36b 0 8px,#ba8bff 8px 16px)';
        case 'grad-sunrise': return 'linear-gradient(90deg,#ff9a9e,#fad0c4,#ffd1ff)';
        case 'grad-sea': return 'linear-gradient(90deg,#36d1dc,#5b86e5)';
        case 'stripe-gold-silver': return 'repeating-linear-gradient(45deg,#ffd700 0 8px,#c0c0c0 8px 16px)';
        case 'grad-sunset': return 'linear-gradient(90deg,#0b486b,#f56217)';
        case 'god-rainbow': return 'linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)';
        default: return '#ffffff';
      }
    }

    // --------- 게임과 상호작용 ----------
    window.GameInterop = {
      async saveScore(score){
        const { data: { user } } = await supa.auth.getUser();
        if (!user) return { ok:false, reason:'로그인 필요' };
        const payload = { user_id: user.id, score: Math.floor(score) };
        const { error } = await supa.from('scores').insert([payload]);
        if (error) return { ok:false, reason:error.message };
        await fetchBestScore(user.id); applyHeaderUI();
        return { ok:true };
      },
      // 보스 클리어: 보스번호 n (1,2,3...) → 3번째부터 보상
      async onBossClear(n){
        if (n >= 3){
          const add = (n - 2) * 10;
          await addGold(add);
          toast(`Boss ${n} 클리어 +${add}G`);
        }
      },
      getSelectedSkin(){
        return profile?.selected_skin || 'white';
      }
    };

    async function addGold(amount){
      const newGold = (profile.gold ?? 0) + amount;
      const { error } = await supa.from('profiles').update({ gold:newGold }).eq('user_id', profile.user_id);
      if (!error){ profile.gold = newGold; $('#goldText').textContent = newGold; updateProfileModalUI(); }
    }

    function toast(msg){
      const t = $('#saveToast');
      t.textContent = msg;
      setTimeout(()=> t.textContent = '', 2500);
    }
  </script>
  <script type="module" src="./game.js"></script>
</body>
</html>
