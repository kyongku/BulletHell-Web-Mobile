<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>BulletHell â€” Mobile</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* ì´ˆê¸° ë¡œë”© ì˜¤ë²„ë ˆì´: ë¡œê·¸ì¸ í™•ì¸ ì¤‘ì— UI ê¹œë¹¡ì„ ë°©ì§€ */
    #authGate {
      position: fixed; inset: 0; display: grid; place-items: center;
      background: rgba(0,0,0,.7); color: #e6e6e6; z-index: 9999;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    /* í”„ë¡œí•„ ëª¨ë‹¬ í•˜ë‹¨ ë²„íŠ¼ ì¢Œ/ìš° ë°°ì¹˜ */
    #profileModal .row.actions {
      display: flex; justify-content: space-between; align-items: center;
    }
  </style>
</head>
<body>
  <div id="authGate">ë¡œê·¸ì¸ í™•ì¸ ì¤‘...</div>

  <header id="topBar" class="hidden">
    <button id="profileBtn" class="profile" title="í”„ë¡œí•„">
      <!-- â–¶ ë³€ê²½: í—¤ë” ì•„ë°”íƒ€ì— id ë¶€ì—¬(ì„ íƒ ì´ëª¨ì§€ ë™ê¸°í™” ëŒ€ìƒ) -->
      <div class="avatar" id="profileEmoji">â­</div>
      <div class="who">
        <div id="profileName">ë¡œê·¸ì¸ í•„ìš”</div>
        <div class="best">Best: <span id="profileBest">0</span></div>
      </div>
    </button>
    <div class="spacer"></div>
    <div class="goldBox">Gold: <span id="goldText">0</span></div>
    <button id="btnGacha" class="primary">ë½‘ê¸°(100G)</button>
    <button id="btnPatch" class="ghost">íŒ¨ì¹˜ë…¸íŠ¸</button>
    <button id="btnRanking" class="ghost">ë­í‚¹</button>
    <!-- â–¶ ì¶”ê°€: ì´ëª¨ì§€ ìƒì  ë²„íŠ¼(ë©”ì¸ì—ì„œë§Œ ë…¸ì¶œ) -->
    <button id="btnEmojiShop" class="ghost">ì´ëª¨ì§€ ìƒì </button>
  </header>

  <main id="mainMenu" class="hidden">
    <h1>BulletHell â€” Mobile</h1>
    <p class="muted">350Ã—350 â€¢ ê³„ì •/ë­í‚¹ â€¢ ë³´ìŠ¤ â€¢ ìŠ¤í‚¨ ê°€ì±  â€¢ HUD</p>
    <button id="btnStart" class="primary">ê²Œì„ ì‹œì‘</button>
  </main>

  <section id="gameWrap" class="hidden">
    <div class="top-hud" aria-label="ìƒë‹¨ HUD">
      <div class="hpbar" role="progressbar" aria-valuemin="0">
        <div id="hpFill" class="hp-fill"></div>
      </div>
      <div class="hptext" id="hpText">100 / 100</div>
      <div class="score-wrap">Score: <span id="liveScore">0</span></div>
    </div>

    <canvas id="gameCanvas" width="350" height="350" aria-label="ê²Œì„ ë³´ë“œ"></canvas>

    <div id="hudBar">
      <div id="pad" class="pad" role="group" aria-label="ì¡°ì´ìŠ¤í‹±">
        <div id="stick" class="stick"></div>
      </div>
    </div>
  </section>

  <!-- ê²Œì„ì˜¤ë²„ -->
  <div id="over" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h2 style="margin:0 0 6px 0;">ê²Œì„ ì˜¤ë²„</h2>
      <div class="muted">ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span></div>
      <div class="row actions">
        <button id="btnToMenu" class="secondary">ë©”ì¸ í™”ë©´</button>
        <button id="btnSaveRank" class="primary">ë­í‚¹ ì…ë ¥</button>
      </div>
      <div id="saveToast" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- ë‹‰ë„¤ì„ ì„¤ì • -->
  <div id="nickModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">ë‹‰ë„¤ì„ ì„¤ì •</h3>
      <p class="muted">í•œê¸€/ì˜ë¬¸/ìˆ«ì 2~12ì. ìµœì´ˆ 1íšŒë§Œ ì„¤ì •.</p>
      <input id="nickInput" type="text" maxlength="12" placeholder="ì˜ˆ: í™ê¸¸ë™" />
      <div class="row actions">
        <button id="btnNickSave" class="primary">ì €ì¥</button>
      </div>
      <div id="nickMsg" class="muted"></div>
    </div>
  </div>

  <!-- í”„ë¡œí•„/ìŠ¤í‚¨ + â–¶ ì¶”ê°€: ì´ëª¨ì§€ ì„ íƒ -->
  <div id="profileModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">í”„ë¡œí•„</h3>
      <div class="muted" id="profInfo">ë‹‰ë„¤ì„ / ìµœê³ ì  / Gold</div>

      <h4 style="margin:10px 0 6px 0;">ìŠ¤í‚¨ ì„ íƒ</h4>
      <div id="skinGrid" class="skin-grid"></div>

      <!-- â–¶ ì¶”ê°€: ì´ëª¨ì§€ ì„ íƒ ì„¹ì…˜ -->
      <h4 style="margin:10px 0 6px 0;">ì´ëª¨ì§€ ì„ íƒ</h4>
      <div id="emojiGrid" class="skin-grid"></div>
      <p class="muted">ì´ëª¨ì§€ëŠ” ìƒì /ë½‘ê¸°ë¡œ í•´ê¸ˆ í›„ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”.</p>

      <div class="row actions" style="margin-top:10px;">
        <button id="btnProfileClose" class="ghost">ë‹«ê¸°</button>
        <button id="btnLogout" class="secondary">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>

  <!-- ê°€ì±  -->
  <div id="gachaModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">ë½‘ê¸° (100 Gold)</h3>
      <div class="muted">í™•ë¥ : N 80% / R 15% / E 4.45% / L 0.45% / GOD 0.05%</div>
      <div id="gachaResult" class="gacha-result muted" style="min-height:24px;margin:8px 0 6px 0;"></div>
      <div class="row actions">
        <button id="btnDoGacha" class="primary">ë½‘ê¸°í•˜ê¸°</button>
        <button id="btnGachaClose" class="ghost">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- íŒ¨ì¹˜ë…¸íŠ¸ -->
  <div id="patchModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">íŒ¨ì¹˜ë…¸íŠ¸</h3>
      <div id="patchList" class="patchlist"></div>
      <div class="row actions">
        <button id="btnPatchClose" class="ghost">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- â–¶ ì¶”ê°€: ì´ëª¨ì§€ ìƒì (ë©”ì¸ ì „ìš©) -->
  <div id="emojiShopModal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">ì´ëª¨ì§€ ìƒì </h3>
      <div id="emojiShopGrid" class="emoji-shop"></div>
      <div class="row actions" style="margin-top:10px;">
        <div class="muted">ë³´ìœ  ê³¨ë“œ: <span id="shopGold">0</span></div>
        <button id="btnEmojiShopClose" class="ghost">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- â˜… ì „ì—­ ì£¼ì…: game.jsë³´ë‹¤ ë¨¼ì € ë¡œë“œë˜ì–´ì•¼ í•¨ -->
  <script type="module">
    import * as supabase from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    window.supabase = supabase;
  </script>

  <!-- í˜ì´ì§€ ë¡œì§ (ì„¸ì…˜: sessionStorage) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supa = createClient(
      'https://pecoerlqanocydrdovbb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlY29lcmxxYW5vY3lkcmRvdmJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzM4ODYsImV4cCI6MjA3MDc0OTg4Nn0.gbQlIPV89_IecGzfVxsnjuzLe-TStTYQqMKzV-B4CUs',
      { auth: { persistSession: true, autoRefreshToken: true, storage: window.sessionStorage } }
    );

    const $ = (s)=>document.querySelector(s);
    const show = (el)=>el.classList.remove('hidden');
    const hide = (el)=>el.classList.add('hidden');
    const genTag4 = () => String(Math.floor(1000 + Math.random()*9000));

    let currentUser = null, profile = null, bestScore = 0;

    // ---------- ë¡œê·¸ì¸ í™•ì¸ & ì´ˆê¸°í™” ----------
    (async () => {
      await new Promise(r=>setTimeout(r, 60)); // ëª¨ë“ˆ/ì„¸ì…˜ ë™ê¸°í™” ëŒ€ê¸°
      const { data: { user } } = await supa.auth.getUser();
      if (!user) { location.href = './login.html'; return; }  // ë¯¸ë¡œê·¸ì¸ â†’ ë¡œê·¸ì¸ í˜ì´ì§€
      currentUser = user;

      await ensureProfile(user);
      await loadProfile(user);

      // RPCì—ì„œ í˜„ì¬ ì´ ê³¨ë“œ ì½ì–´ì™€ì„œ profiles/í—¤ë”ì— ë°˜ì˜
      try {
        const { data: total, error: terr } = await supa.rpc('wallet_add_gold', { delta: 0 });
        if (!terr && typeof total === 'number') {
          await supa.from('profiles').update({ gold: total }).eq('user_id', currentUser.id);
          profile.gold = total;
        }
      } catch (_) {}

      await fetchBestScore(user.id);
      applyHeaderUI();
      buildSkinGrid();

      // â–¶ ì¶”ê°€: ì´ëª¨ì§€ ê·¸ë¦¬ë“œ/ìƒì  ì¤€ë¹„
      buildEmojiGrid();
      // window.GameConfig.selectedSkin ìœ ì§€
      window.GameConfig = { get selectedSkin(){ return profile?.selected_skin || 'white'; } };

      // UI í‘œì‹œ
      document.getElementById('authGate')?.remove();
      show(document.getElementById('topBar'));
      show(document.getElementById('mainMenu'));
    })();

    // ---------- ìŠ¤í‚¨/ê°€ì±  ë°ì´í„° ----------
    const ALL_SKINS = [
      // N
      { id:'white', name:'White', grade:'N' },{ id:'mint', name:'Mint', grade:'N' },
      { id:'sky', name:'Sky', grade:'N' },{ id:'lime', name:'Lime', grade:'N' },
      { id:'orange', name:'Orange', grade:'N' },{ id:'violet', name:'Violet', grade:'N' },
      { id:'aqua', name:'Aqua', grade:'N' },
      // R
      { id:'stripe-mint-sky', name:'Stripe Mint/Sky', grade:'R' },
      { id:'stripe-orange-violet', name:'Stripe Orange/Violet', grade:'R' },
      // E
      { id:'grad-sunrise', name:'Grad Sunrise', grade:'E' },
      { id:'grad-sea',     name:'Grad Sea',     grade:'E' },
      // L
      { id:'stripe-gold-silver', name:'Stripe Gold/Silver', grade:'L' },
      { id:'grad-sunset',        name:'Grad Sunset',        grade:'L' },
      // GOD
      { id:'god-rainbow', name:'GOD Rainbow', grade:'GOD' }
    ];
    const GRADE_POOL = [
      { grade:'GOD', p:0.005, skins:ALL_SKINS.filter(s=>s.grade==='GOD') },
      { grade:'L',   p:0.02,  skins:ALL_SKINS.filter(s=>s.grade==='L') },
      { grade:'E',   p:0.075, skins:ALL_SKINS.filter(s=>s.grade==='E') },
      { grade:'R',   p:0.20,  skins:ALL_SKINS.filter(s=>s.grade==='R') },
      { grade:'N',   p:0.70,  skins:ALL_SKINS.filter(s=>s.grade==='N') },
    ];
    function pickGacha(){
      const r=Math.random(); let acc=0;
      for(const g of GRADE_POOL){ acc+=g.p; if(r<=acc){ const arr=g.skins; return { grade:g.grade, skin:arr[Math.floor(Math.random()*arr.length)] }; } }
      const last=GRADE_POOL.at(-1); return { grade:last.grade, skin:last.skins[0] };
    }
    function gradeBadge(g){ const map={N:'N', R:'R', E:'E', L:'L', GOD:'G'}; return `<span class="badge g-${g}">${map[g]||g}</span>`; }
    function previewCSS(id){
      switch(id){
        case 'white': return '#ffffff'; case 'mint': return '#7ef5d1'; case 'sky': return '#7ecbff';
        case 'lime': return '#a6ff6b'; case 'orange': return '#ffb36b'; case 'violet': return '#ba8bff'; case 'aqua': return '#6bfffb';
        case 'stripe-mint-sky': return 'repeating-linear-gradient(45deg,#7ef5d1 0 8px,#7ecbff 8px 16px)';
        case 'stripe-orange-violet': return 'repeating-linear-gradient(45deg,#ffb36b 0 8px,#ba8bff 8px 16px)';
        case 'grad-sunrise': return 'linear-gradient(90deg,#ff9a9e,#fad0c4,#ffd1ff)';
        case 'grad-sea': return 'linear-gradient(90deg,#36d1dc,#5b86e5)';
        case 'stripe-gold-silver': return 'repeating-linear-gradient(45deg,#ffd700 0 8px,#c0c0c0 8px 16px)';
        case 'grad-sunset': return 'linear-gradient(90deg,#0b486b,#f56217)';
        case 'god-rainbow': return 'linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)';
        default: return '#ffffff';
      }
    }

    // ---------- í”„ë¡œí•„/ìŠ¤í‚¨ UI ----------
    function buildSkinGrid(){
      const grid = document.getElementById('skinGrid');
      const have = new Set(profile.unlocked_skins||['white']);
      grid.innerHTML = ALL_SKINS.map(s=>{
        const owned = have.has(s.id);
        const sel = profile.selected_skin === s.id;
        return `
          <button class="chip ${owned?'':'chip-lock'} ${sel?'chip-sel':''}" data-id="${s.id}">
            <span class="chip-color" data-skin="${s.id}"></span>
            <span>${s.name}</span>
            ${gradeBadge(s.grade)}
          </button>`;
      }).join('');
      grid.querySelectorAll('button.chip').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-id');
          if (!have.has(id)) return;
          if (profile.selected_skin === id) return;
          const { error } = await supa.from('profiles').update({ selected_skin:id }).eq('user_id', profile.user_id);
          if (!error){ profile.selected_skin = id; buildSkinGrid(); }
        };
      });
      grid.querySelectorAll('.chip-color').forEach(span=>{
        const id = span.getAttribute('data-skin');
        span.style.background = previewCSS(id);
      });
    }
    function updateProfileModalUI(){
      document.getElementById('profInfo').textContent =
        `${profile.nickname}#${profile.tag} / Best ${bestScore} / Gold ${profile.gold}`;
    }

    // ---------- ê³„ì •/ë² ìŠ¤íŠ¸ìŠ¤ì½”ì–´ ----------
    async function ensureProfile(user){
      const { data: p } = await supa.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      if (p) return;
      document.getElementById('nickModal').classList.remove('hidden');
      await new Promise(resolve=>{
        document.getElementById('btnNickSave').onclick = async ()=>{
          const name = document.getElementById('nickInput').value.trim();
          if (!name || name.length < 2) { document.getElementById('nickMsg').textContent = '2~12ì ë‹‰ë„¤ì„ ì…ë ¥'; return; }
          let tag = genTag4(), tries=0, ok=false;
          while(!ok && tries<8){
            const { data:t } = await supa.from('profiles').select('user_id').eq('nickname', name).eq('tag', tag).maybeSingle();
            if (!t) ok = true; else { tag = genTag4(); tries++; }
          }
          const row = { user_id: user.id, nickname: name, tag, gold: 0, selected_skin: 'white', unlocked_skins: ['white'],
                        /* â–¶ ì¶”ê°€: ì´ëª¨ì§€ ê¸°ë³¸ê°’ */ selected_emoji:'â­', unlocked_emojis:['â­'] };
          const { error } = await supa.from('profiles').insert([row]);
          if (error){ document.getElementById('nickMsg').textContent = 'ì‹¤íŒ¨: '+error.message; return; }
          document.getElementById('nickModal').classList.add('hidden');
          resolve();
        };
      });
    }
    async function loadProfile(user){
      const { data } = await supa.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      profile = data || {};
      const patch = {};
      if (profile.gold == null) patch.gold = 0;
      if (!profile.selected_skin) patch.selected_skin = 'white';
      if (!Array.isArray(profile.unlocked_skins)) patch.unlocked_skins = ['white'];
      // â–¶ ì¶”ê°€: ì´ëª¨ì§€ í•„ë“œ ë³´ì •
      if (!profile.selected_emoji) patch.selected_emoji = 'â­';
      if (!Array.isArray(profile.unlocked_emojis)) patch.unlocked_emojis = ['â­'];
      if (Object.keys(patch).length){
        await supa.from('profiles').update(patch).eq('user_id', user.id);
        Object.assign(profile, patch);
      }
    }
    async function fetchBestScore(uid){
      const { data } = await supa.from('scores').select('score').eq('user_id', uid).order('score', {ascending:false}).limit(1);
      bestScore = (data && data[0]) ? data[0].score : 0;
    }
    function applyHeaderUI(){
      const nameTag = (profile.nickname||'user') + '#' + (profile.tag||'0000');
      document.getElementById('profileName').textContent = nameTag;
      document.getElementById('profileBest').textContent = String(bestScore||0);
      document.getElementById('goldText').textContent = profile.gold ?? 0;
      // â–¶ ì¶”ê°€: í—¤ë” ì´ëª¨ì§€ ë°˜ì˜
      document.getElementById('profileEmoji').textContent = profile.selected_emoji || 'â­';
    }

    // ---------- â–¶ ì¶”ê°€: ì´ëª¨ì§€ ì¹´íƒˆë¡œê·¸ & UI/êµ¬ë§¤ ----------
    const EMOJI_STORE = [
      { id:'e_star',   emoji:'â­', name:'Star',   price:  0 }, // ê¸°ë³¸ ë¬´ë£Œ
      { id:'e_smile',  emoji:'ğŸ˜„', name:'Smile',  price: 60 },
      { id:'e_fire',   emoji:'ğŸ”¥', name:'Fire',   price:120 },
      { id:'e_crown',  emoji:'ğŸ‘‘', name:'Crown',  price:180 },
      { id:'e_rocket', emoji:'ğŸš€', name:'Rocket', price:200 },
      { id:'e_skull',  emoji:'ğŸ’€', name:'Skull',  price:200 },
      { id:'e_dragon', emoji:'ğŸ‰', name:'Dragon', price:260 },
      { id:'e_trophy', emoji:'ğŸ†', name:'Trophy', price:300 }
    ];

    function buildEmojiGrid(){
      const grid = document.getElementById('emojiGrid');
      if (!grid) return;
      const have = new Set(profile.unlocked_emojis || ['â­']);
      const selected = profile.selected_emoji || 'â­';
      grid.innerHTML = EMOJI_STORE.map(e=>{
        const owned = have.has(e.emoji) || e.price===0;
        const sel = selected === e.emoji;
        return `
          <button class="chip ${owned?'':'chip-lock'} ${sel?'chip-sel':''}" data-emoji="${e.emoji}">
            <span class="chip-color" style="display:grid;place-items:center;font-size:16px;background:#1a2332">${e.emoji}</span>
            <span>${e.name}</span>
          </button>`;
      }).join('');
      grid.querySelectorAll('[data-emoji]').forEach(btn=>{
        btn.onclick = async ()=>{
          const pick = btn.getAttribute('data-emoji');
          if (!have.has(pick) && pick!=='â­') return;
          if (profile.selected_emoji === pick) return;
          const { error } = await supa.from('profiles').update({ selected_emoji: pick }).eq('user_id', profile.user_id);
          if (!error){
            profile.selected_emoji = pick;
            applyHeaderUI();
            buildEmojiGrid();
          }
        };
      });
    }

    function buildEmojiShop(){
      const grid = document.getElementById('emojiShopGrid');
      if (!grid) return;
      const have = new Set(profile.unlocked_emojis || ['â­']);
      grid.innerHTML = EMOJI_STORE.map(e=>{
        const owned = have.has(e.emoji) || e.price===0;
        return `
          <div class="item">
            <div class="icon">${e.emoji}</div>
            <div class="meta">
              <div class="nm">${e.name}</div>
              <div class="pr">ğŸ’° ${e.price}</div>
            </div>
            <button class="buy" data-buy="${e.id}" ${owned?'disabled':''}>${owned?'ë³´ìœ ì¤‘':'êµ¬ë§¤'}</button>
          </div>`;
      }).join('');
      grid.querySelectorAll('[data-buy]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-buy');
          const item = EMOJI_STORE.find(x=>x.id===id); if (!item) return;
          const owned = (profile.unlocked_emojis||[]).includes(item.emoji) || item.price===0;
          if (owned) return;

          // ê³¨ë“œ ì°¨ê°
          const { data: newTotal, error: rpcErr } = await supa.rpc('wallet_add_gold', { delta: -item.price });
          if (rpcErr) { toast('ê³¨ë“œ ì°¨ê° ì‹¤íŒ¨'); return; }
          profile.gold = (newTotal|0);

          // ë³´ìœ  ì´ëª¨ì§€ ì¶”ê°€
          const next = Array.from(new Set([...(profile.unlocked_emojis||['â­']), item.emoji]));
          const { error } = await supa.from('profiles').update({ unlocked_emojis: next }).eq('user_id', profile.user_id);
          if (error) { toast('ì €ì¥ ì‹¤íŒ¨'); return; }
          profile.unlocked_emojis = next;

          // UI ê°±ì‹ 
          applyHeaderUI();
          buildEmojiShop();
          buildEmojiGrid();
          toast(`êµ¬ë§¤ ì™„ë£Œ: ${item.emoji} ${item.name}`);
        };
      });
    }

    function toast(msg){
      const el = document.getElementById('saveToast');
      if (el){ el.textContent = msg; setTimeout(()=> el.textContent='', 1800); }
    }

    // ---------- ë²„íŠ¼ë“¤ ----------
    document.getElementById('btnRanking').onclick = ()=> location.href='./ranking/';
    document.getElementById('btnPatch').onclick = async ()=>{
      document.getElementById('patchList').textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      const { data, error } = await supa.from('updates').select('title,content,created_at').order('created_at', {ascending:false}).limit(3);
      if (error) { document.getElementById('patchList').textContent='ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+error.message; return; }
      document.getElementById('patchList').innerHTML = data.map(u => `
        <article class="note">
          <h4>${u.title}</h4>
          <div class="muted">${new Date(u.created_at).toLocaleString()}</div>
          <p>${u.content}</p>
        </article>
      `).join('');
      document.getElementById('patchModal').classList.remove('hidden');
    };
    document.getElementById('btnPatchClose').onclick = ()=> document.getElementById('patchModal').classList.add('hidden');

    document.getElementById('btnStart').onclick = ()=>{
      document.getElementById('mainMenu').classList.add('hidden');
      document.getElementById('gameWrap').classList.remove('hidden');
      // â–¶ ì¶”ê°€: ë©”ì¸ ì „ìš© í—¤ë” ìˆ¨ê¹€(ê²Œì„ ì¤‘ì—” ë³´ì´ì§€ ì•Šê²Œ)
      document.getElementById('topBar').classList.add('hidden');
      window.startGame && window.startGame();
    };

    document.getElementById('profileBtn').onclick = ()=>{
      updateProfileModalUI();
      buildEmojiGrid(); // ìµœì‹  ë³´ìœ /ì„ íƒ ë°˜ì˜
      document.getElementById('profileModal').classList.remove('hidden');
    };
    document.getElementById('btnProfileClose').onclick = ()=> document.getElementById('profileModal').classList.add('hidden');

    // ë¡œê·¸ì•„ì›ƒ(í”„ë¡œí•„ ëª¨ë‹¬ ì˜¤ë¥¸ìª½ ì•„ë˜)
    document.getElementById('btnLogout').onclick = async ()=>{
      try { await supa.auth.signOut(); } catch(_){}
      sessionStorage.clear();
      location.href = './login.html';
    };

    document.getElementById('btnGacha').onclick = ()=>{
      document.getElementById('gachaResult').textContent = '';
      document.getElementById('gachaModal').classList.remove('hidden');
    };
    document.getElementById('btnGachaClose').onclick = ()=> document.getElementById('gachaModal').classList.add('hidden');
    document.getElementById('btnDoGacha').onclick = async ()=>{
      if ((profile.gold ?? 0) < 100){
        document.getElementById('gachaResult').textContent = 'Goldê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.';
        return;
      }
      const { grade, skin } = pickGacha();
      const newGold = (profile.gold ?? 0) - 100;
      const set = new Set(profile.unlocked_skins || []);
      set.add(skin.id);
      const updates = { gold:newGold, unlocked_skins:Array.from(set) };
      const { error } = await supa.from('profiles').update(updates).eq('user_id', profile.user_id);
      if (error){ document.getElementById('gachaResult').textContent = 'ì˜¤ë¥˜: '+error.message; return; }
      Object.assign(profile, updates);
      applyHeaderUI(); buildSkinGrid(); updateProfileModalUI(); buildEmojiGrid();
      document.getElementById('gachaResult').textContent = `ë‹¹ì²¨! [${grade}] ${skin.name}`;
    };

    // â–¶ ì¶”ê°€: ì´ëª¨ì§€ ìƒì  ì—´ê¸°/ë‹«ê¸°
    document.getElementById('btnEmojiShop').onclick = ()=>{
      document.getElementById('shopGold').textContent = profile?.gold ?? 0;
      buildEmojiShop();
      document.getElementById('emojiShopModal').classList.remove('hidden');
    };
    document.getElementById('btnEmojiShopClose').onclick = ()=>{
      document.getElementById('emojiShopModal').classList.add('hidden');
    };
  </script>

  <!-- game.js: window.supabase ì‚¬ìš© (ìœ„ ì „ì—­ ì£¼ì… ì´í›„ ë¡œë“œ) -->
  <script type="module" src="./game.js"></script>
</body>
</html>
