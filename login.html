<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>로그인 — BulletHell</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    :root { --card:#0e0f12; --card-bd:#1f2230; }
    body { margin:0; color:#e7e7ea; background:#0b0c10; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple SD Gothic Neo, Noto Sans KR, "맑은 고딕", Malgun Gothic, sans-serif; }
    main.login { display:grid; place-items:center; padding:24px 14px; min-height:100dvh; }
    .box { width:min(92vw,480px); background:var(--card); border:1px solid var(--card-bd); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,.35); }
    .title { font-weight:800; margin:0 0 10px 0; letter-spacing:.2px; }
    .row { display:grid; gap:8px; }
    label.muted { font-size:12px; opacity:.75; }
    input { background:#11131a; border:1px solid #212435; color:#e7e7ea; border-radius:8px; padding:10px 12px; outline:none; }
    input:focus { border-color:#4f7cff; box-shadow:0 0 0 3px rgba(79,124,255,.15); }
    .actions { display:flex; gap:8px; margin-top:10px; }
    button { border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
    button.primary { background:#4f7cff; color:white; }
    button.secondary { background:#23283a; color:#d7d8de; }
    button.ghost { background:transparent; color:#aab0c6; border:1px solid #343a53; }
    .muted { color:#aab0c6; font-size:12px; min-height:16px; }
    hr { border:0; border-top:1px solid rgba(255,255,255,.08); }
  </style>
</head>
<body>
  <main class="login">
    <div class="box">
      <h2 class="title">로그인</h2>
      <div class="row">
        <label class="muted">이메일</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="username"/>
        <label class="muted">비밀번호</label>
        <input id="pass" type="password" placeholder="8자 이상" autocomplete="current-password"/>
        <div class="actions">
          <button id="btnLogin" class="primary">로그인</button>
          <button id="btnSignup" class="secondary">회원가입</button>
        </div>
        <div id="msg" class="muted"></div>
      </div>

      <hr style="margin:14px 0;"/>

      <div class="row" id="nickArea" style="display:none">
        <h3 class="title" style="font-size:18px; margin:0">닉네임 설정(최초 1회)</h3>
        <input id="nick" type="text" maxlength="12" placeholder="예: 경구"/>
        <button id="btnNick" class="primary">저장</button>
        <div id="nickMsg" class="muted"></div>
      </div>

      <div class="actions" style="justify-content:flex-end; margin-top:10px;">
        <a href="./index.html" class="ghost" style="text-decoration:none;"><button class="ghost" type="button">게임으로</button></a>
      </div>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // 세션을 sessionStorage에 저장(같은 탭에서 페이지 이동 시 유지)
    const supa = createClient(
      'https://pecoerlqanocydrdovbb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlY29lcmxxYW5vY3lkcmRvdmJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzM4ODYsImV4cCI6MjA3MDc0OTg4Nn0.gbQlIPV89_IecGzfVxsnjuzLe-TStTYQqMKzV-B4CUs',
      {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          storage: window.sessionStorage
        }
      }
    );

    const email = document.getElementById('email');
    const pass  = document.getElementById('pass');
    const msg   = document.getElementById('msg');
    const nickArea  = document.getElementById('nickArea');
    const nickInput = document.getElementById('nick');
    const nickMsg   = document.getElementById('nickMsg');

    const genTag4 = () => String(Math.floor(1000 + Math.random()*9000));

    async function ensureProfile(user){
      const { data: exist } = await supa.from('profiles').select('user_id').eq('user_id', user.id).maybeSingle();
      if (exist) return true;
      nickArea.style.display = 'grid';
      return new Promise((resolve)=>{
        document.getElementById('btnNick').onclick = async ()=>{
          const name = (nickInput.value || '').trim();
          if (!name || name.length<2) { nickMsg.textContent='2~12자 닉네임 입력'; return; }
          let tag=genTag4(), tries=0, ok=false;
          while(!ok && tries<8){
            const { data: t } = await supa.from('profiles').select('user_id').eq('nickname', name).eq('tag', tag).maybeSingle();
            if (!t) ok=true; else { tag = genTag4(); tries++; }
          }
          const row = { user_id:user.id, nickname:name, tag, gold:0, selected_skin:'white', unlocked_skins:['white'] };
          const { error } = await supa.from('profiles').insert([row]);
          if (error){ nickMsg.textContent = '실패: '+error.message; return; }
          resolve(true);
        };
      });
    }

    async function postLogin(){
      const { data: { user } } = await supa.auth.getUser();
      if (!user) return;
      await ensureProfile(user);
      location.href = './index.html';
    }

    document.getElementById('btnLogin').onclick = async ()=>{
      msg.textContent = '로그인 중...';
      const { error } = await supa.auth.signInWithPassword({ email: email.value, password: pass.value });
      if (error) { msg.textContent = '실패: '+error.message; return; }
      msg.textContent = '완료'; await postLogin();
    };

    document.getElementById('btnSignup').onclick = async ()=>{
      msg.textContent = '가입 중...';
      const { error } = await supa.auth.signUp({ email: email.value, password: pass.value });
      if (error) { msg.textContent = '실패: '+error.message; return; }
      msg.textContent = '가입 완료. 메일 확인 후 다시 로그인하세요.';
    };

    // 이미 로그인된 상태면 자동으로 게임으로 넘김
    (async ()=>{
      const { data: { session } } = await supa.auth.getSession();
      if (session) location.href='./index.html';
    })();
  </script>
</body>
</html>
